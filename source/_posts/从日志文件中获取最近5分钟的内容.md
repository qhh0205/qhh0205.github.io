---
title: 从日志文件中获取最近5分钟的内容
date: 2018-01-10 23:19:47
categories: [Shell脚本]
tags: Shell
---

今天突然有这么个需求，每隔5分钟检测一次日志文件中是否有某个关键字，如果没有则发送报警，如果有则不做任何处理。其实问题的关键就是如果获取最近5分钟内的日志，然后启个crontab。实现思路比较简单，循环获取5分钟内的时间戳，然后从日志文件中grep这个时间戳即可。代码如下：
``` bash
#!/usr/bin/env bash
# -*- coding: utf-8 -*-
# @Time    : 2018/1/10 下午4:26
# @Author  : qianghaohao
# @Mail    : codenutter@foxmail.com
# @File    : monitor.sh

EMAIL=''
PHONE=''
MSG="`date +"%Y-%m-%d %H:%M:%S"`|xxx服务出现异常，请注意查看!"
LOG_FILE=xxx
KEY_WORDS="xxx"

cat /dev/null > tmp.txt
for (( i = 5; i >=0; i-- )) ; do
     grep "^$(date +"%Y-%m-%d %H:%M" -d "-$i  min")" $LOG_FILE >> tmp.txt
done

if [ -z "`cat tmp.txt | grep "$KEY_WORDS"`" ]; then
    echo "`date +"%Y-%m-%d %H:%M:%S"`|Sever Error!" >> server_error.log
    python email_alert.py "$EMAIL" "$MSG"
    python sms_alert.py "$PHONE" "$MSG"
else
    echo "`date +"%Y-%m-%d %H:%M:%S"`|Server nomormal!" > monitor.log
fi

exit 0
```
