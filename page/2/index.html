<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Talk is cheap. Show me the code.">
<meta property="og:type" content="website">
<meta property="og:title" content="Jim">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Jim">
<meta property="og:description" content="Talk is cheap. Show me the code.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jim">
<meta name="twitter:description" content="Talk is cheap. Show me the code.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Jim</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jim</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Talk is cheap. Show me the code.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/24/MySQL-慢查询日志导入-Elasticsearch-可视化查询分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/24/MySQL-慢查询日志导入-Elasticsearch-可视化查询分析/" itemprop="url">MySQL 慢查询日志导入 Elasticsearch 可视化查询分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-24T15:59:40+08:00">
                2019-10-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当应用程序后台 SQL 查询慢的时候我们一般第一时间会查看数据库慢查询记录，但是慢查询记录是原始文本，直接查询搜索分析比较费时费力，虽然业界有针对 MySQL 慢查询分析的命令行工具（比如：<a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-query-digest.html" target="_blank" rel="noopener">pt-query-digest</a>），但是使用起来还是不够方便，而且分析结果也是针对整个实例的大概统计，不能及时定位到某个应用（库.表）的慢查询。出于这个目的我们可以将 MySQL 原始慢查询日志结构化导入 Elasticsearch，然后通过 Kibana 可视化查询分析，由于日志结构化解析出来了，所以可以快速查询分析。本文主要介绍如何运用业界主流的开源工具链实现这一需求，整体架构如下：<br><img src="/images/elk-mysql-slow-log.png" alt=""></p>
<h3 id="工具链集合"><a href="#工具链集合" class="headerlink" title="工具链集合"></a>工具链集合</h3><ol>
<li><a href="https://www.elastic.co/cn/products/beats/filebeat" target="_blank" rel="noopener">Filebeat</a>：日志收集端，使用 Filebeat 的 <a href="https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-module-mysql.html" target="_blank" rel="noopener">MySQL 模块</a>结构化解析慢查询日志并写入到 Elasticsearch。</li>
<li><a href="https://www.elastic.co/cn/" target="_blank" rel="noopener">Elasticsearch</a>：存储 Filebeat 发送过来的日志消息；</li>
<li><a href="https://www.elastic.co/cn/products/kibana" target="_blank" rel="noopener">Kibana</a>：可视化查询分析 Elasticsearch 存储的日志数据；</li>
<li>docker-compose：容器化快速启动 Elasticsearch + Kibana 组件；</li>
</ol>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>docker-compose 启动 Elasticsearch + Kibana 组件，然后使用 Filebeat 自带的 MySQL 模块结构化慢查询日志并传输到 Elasticsearch。</p>
<h4 id="docker-compose-启动-Elasticsearch-Kibana-组件"><a href="#docker-compose-启动-Elasticsearch-Kibana-组件" class="headerlink" title="docker-compose 启动 Elasticsearch + Kibana 组件"></a>docker-compose 启动 Elasticsearch + Kibana 组件</h4><ul>
<li>Elasticsearch 7.4.0</li>
<li>Kibana 7.4.0</li>
</ul>
<p>docker-compose.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  esnet:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  elasticsearch:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.4.0</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node.name=es01</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">discovery.seed_hosts=es01</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cluster.initial_master_nodes=es01</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cluster.name=docker-cluster</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"ES_JAVA_OPTS=-Xms4096m -Xmx4096m"</span></span><br><span class="line"><span class="attr">    ulimits:</span></span><br><span class="line"><span class="attr">      memlock:</span></span><br><span class="line"><span class="attr">        soft:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">        hard:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"9500:9200"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">esnet</span></span><br><span class="line"><span class="attr">  kibana:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.4.0</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"ELASTICSEARCH_HOSTS=http://elasticsearch:9200"</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"5601:5601"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">esnet</span></span><br></pre></td></tr></table></figure></p>
<p>启动：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></p>
<h4 id="安装配置-Filebeat"><a href="#安装配置-Filebeat" class="headerlink" title="安装配置 Filebeat"></a>安装配置 Filebeat</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.4.0-x86_64.rpm</span><br><span class="line">sudo rpm -vi filebeat-7.4.0-x86_64.rpm</span><br></pre></td></tr></table></figure>
<h5 id="配置-Filebeat"><a href="#配置-Filebeat" class="headerlink" title="配置 Filebeat"></a>配置 Filebeat</h5><ol>
<li><p>配置 Filebeat 输出到 Elasticsearch：<br>vim /etc/filebeat/filebeat.yml 填入如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output.elasticsearch:</span><br><span class="line">  <span class="comment"># Array of hosts to connect to.</span></span><br><span class="line">  hosts: [<span class="string">"localhost:9500"</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>激活 filebeat mysql 模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebeat modules <span class="built_in">enable</span> mysql</span><br></pre></td></tr></table></figure>
<p> 关于 Filebeat mysql 模块介绍见这里：<a href="https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-module-mysql.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-module-mysql.html</a></p>
</li>
<li><p>设置初始化环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebeat setup -e</span><br></pre></td></tr></table></figure>
</li>
<li><p>慢查询日志抓取目录路径<br>这里设置为：<code>/data1/web/slow-query/original/*.log</code> 路径<br>vim /etc/filebeat/modules.d/mysql.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- module:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  error:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  slowlog:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">var.paths:</span> <span class="string">["/data1/web/slow-query/original/*.log"]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Filebeat MySQL 慢查询日志解析配置<br>由于我们 MySQL 使用云提供商的 SQL 服务，但是云提供商的 MySQL 实例慢查询日志格式和自搭的有略微的区别，不太是很标准，所以需要自定义日志格式解析表达式，正则表达式符合 logstash Grok 语法，可以在这里调试正则表达式：<a href="http://grokdebug.herokuapp.com/。关于" target="_blank" rel="noopener">http://grokdebug.herokuapp.com/。关于</a> Grok 正则语法的学习资料可以看看这两篇文章，这里不做介绍：<a href="https://xiezefan.me/2017/04/09/elk_in_action_grok_start/" target="_blank" rel="noopener">ELK实战 - Grok简易入门</a>，<a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html" target="_blank" rel="noopener">Logstash 官网：Grok 过滤器插件</a>。</p>
<p> 我们目前慢查询日志格式样例：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Time: 2019-10-23T00:00:22.964315Z</span></span><br><span class="line"><span class="comment"># User@Host: db[db] @  [cloudsqlproxy~192.168.1.11]  thread_id: 87983  server_id: 2945557302</span></span><br><span class="line"><span class="comment"># Query_time: 1.649439  Lock_time: 0.000116 Rows_sent: 1  Rows_examined: 1634</span></span><br><span class="line">use report;</span><br><span class="line">SET timestamp=1571788822;</span><br><span class="line">select * from table <span class="built_in">where</span>  team_id = 71206683786887168  and  definition_id = 142  and  definition_md5 = <span class="string">'acd2e0a2fecb08ceb13c6ae'</span>  and  UNIX_TIMESTAMP(create_time) * 1000 &lt;= 1568851199999  order by create_time desc  <span class="built_in">limit</span> 1;</span><br></pre></td></tr></table></figure>
<p> 对应的 Grok 正则：<br>说明：在 Grok 中转义一个字符使用一个 <code>\</code> 而不是两个 <code>\</code>，比如要转义 <code>[</code> 需要写成 <code>\[</code>。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^<span class="comment"># Time: %&#123;TIMESTAMP_ISO8601:mysql.slowlog.time&#125;\n# User@Host: %&#123;USER:mysql.slowlog.user&#125;\[%&#123;USER:mysql.slowlog.current_user&#125;\] @ %&#123;HOSTNAME:mysql.slowlog.host&#125;? \[([a-zA-Z~]*)?%&#123;IP:mysql.slowlog.ip&#125;?\]%&#123;SPACE&#125;(Id:%&#123;SPACE&#125;%&#123;NUMBER:mysql.slowlog.id:int&#125;)?(%&#123;SPACE&#125;thread_id:%&#123;SPACE&#125;%&#123;NUMBER:mysql.slowlog.thread_id:int&#125;)?(%&#123;SPACE&#125;server_id:%&#123;SPACE&#125;%&#123;NUMBER:mysql.slowlog.server_id&#125;)?\n# Query_time: %&#123;NUMBER:mysql.slowlog.query_time.sec:float&#125;%&#123;SPACE&#125;Lock_time: %&#123;NUMBER:mysql.slowlog.lock_time.sec:float&#125;%&#123;SPACE&#125;Rows_sent: %&#123;NUMBER:mysql.slowlog.rows_sent:int&#125;%&#123;SPACE&#125;Rows_examined: %&#123;NUMBER:mysql.slowlog.rows_examined:float&#125;\n((use|USE) .*;\n)?SET timestamp=%&#123;NUMBER:mysql.slowlog.timestamp&#125;;\n%&#123;GREEDYDATA:mysql.slowlog.query&#125;</span></span><br></pre></td></tr></table></figure>
<p> 将调试好的 Grok 正则写入下面文件中:<br> 说明: 写入下面 pipeline.json 文件中的正则特殊字符需要两个 <code>\</code> 转义，比如要转义 <code>[</code> 需要写成 <code>\\[</code>。<br> /usr/share/filebeat/module/mysql/slowlog/ingest/pipeline.json</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"Pipeline for parsing MySQL slow logs."</span>,</span><br><span class="line">  <span class="attr">"processors"</span>: [&#123;</span><br><span class="line">    <span class="attr">"grok"</span>: &#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"message"</span>,</span><br><span class="line">      <span class="attr">"patterns"</span>:[</span><br><span class="line">        <span class="string">"^# Time: %&#123;TIMESTAMP_ISO8601:mysql.slowlog.time&#125;\n# User@Host: %&#123;USER:mysql.slowlog.user&#125;\\[%&#123;USER:mysql.slowlog.current_user&#125;\\] @ %&#123;HOSTNAME:mysql.slowlog.host&#125;? \\[([a-zA-Z~]*)?%&#123;IP:mysql.slowlog.ip&#125;?\\]%&#123;SPACE&#125;(Id:%&#123;SPACE&#125;%&#123;NUMBER:mysql.slowlog.id:int&#125;)?(%&#123;SPACE&#125;thread_id:%&#123;SPACE&#125;%&#123;NUMBER:mysql.slowlog.thread_id:int&#125;)?(%&#123;SPACE&#125;server_id:%&#123;SPACE&#125;%&#123;NUMBER:mysql.slowlog.server_id&#125;)?\n# Query_time: %&#123;NUMBER:mysql.slowlog.query_time.sec:float&#125;%&#123;SPACE&#125;Lock_time: %&#123;NUMBER:mysql.slowlog.lock_time.sec:float&#125;%&#123;SPACE&#125;Rows_sent: %&#123;NUMBER:mysql.slowlog.rows_sent:int&#125;%&#123;SPACE&#125;Rows_examined: %&#123;NUMBER:mysql.slowlog.rows_examined:float&#125;\n((use|USE) .*;\n)?SET timestamp=%&#123;NUMBER:mysql.slowlog.timestamp&#125;;\n%&#123;GREEDYDATA:mysql.slowlog.query&#125;"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"pattern_definitions"</span> : &#123;</span><br><span class="line">        <span class="attr">"GREEDYMULTILINE"</span> : <span class="string">"(.|\n)*"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"ignore_missing"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="attr">"remove"</span>:&#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"message"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="attr">"date"</span>: &#123;</span><br><span class="line">      <span class="attr">"field"</span>: <span class="string">"mysql.slowlog.time"</span>,</span><br><span class="line">      <span class="attr">"target_field"</span>: <span class="string">"@timestamp"</span>,</span><br><span class="line">      <span class="attr">"formats"</span>: [<span class="string">"ISO8601"</span>],</span><br><span class="line">      <span class="attr">"ignore_failure"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">"on_failure"</span> : [&#123;</span><br><span class="line">    <span class="attr">"set"</span> : &#123;</span><br><span class="line">      <span class="attr">"field"</span> : <span class="string">"error.message"</span>,</span><br><span class="line">      <span class="attr">"value"</span> : <span class="string">"&#123;&#123; _ingest.on_failure_message &#125;&#125;"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> /usr/share/filebeat/module/mysql/slowlog/config/slowlog.yml 文件调整如下：</p>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">paths:</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">range</span> <span class="string">$i,</span> <span class="string">$path</span> <span class="string">:=</span> <span class="string">.paths</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">&#123;&#123;$path&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">exclude_files:</span> <span class="string">['.gz$']</span></span><br><span class="line"><span class="attr">multiline:</span></span><br><span class="line"><span class="attr">  pattern:</span> <span class="string">'^# Time:'</span></span><br><span class="line"><span class="attr">  negate:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  match:</span> <span class="string">after</span></span><br><span class="line"><span class="attr">exclude_lines:</span> <span class="string">['^[\/\w\.]+,</span> <span class="attr">Version:</span> <span class="string">.*</span> <span class="string">started</span> <span class="attr">with:.*']</span> <span class="comment"># Exclude the header</span></span><br></pre></td></tr></table></figure>
<p> 启动 filebeat 开始日志收集：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start filebeat</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Kibana-可视化查询"><a href="#Kibana-可视化查询" class="headerlink" title="Kibana 可视化查询"></a>Kibana 可视化查询</h4><p>在 Kibana 界面创建 filebeat 索引即可实时查看慢查询日志，举例：查看最近 7 天 10s ～ 20s 的慢查询记录：<br><img src="/images/kibana-mysql-slow-log.png" alt=""></p>
<h3 id="遇到的问题及解决方法"><a href="#遇到的问题及解决方法" class="headerlink" title="遇到的问题及解决方法"></a>遇到的问题及解决方法</h3><p>Kibana 首次查看上面建立的索引数据可能会报类似下面的错误，主要原因是单条日志事件过长 Kibana 有限制：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Request to Elasticsearch failed: &#123;"error":&#123;"root_cause":[&#123;"type":"illegal_argument_exception","reason":"The length of [error.message] field of [JHzl020BgPENHIlNYRoc] doc of [filebeat-7.4.0-2019.10.16-000001] <span class="keyword">index</span> has exceeded [<span class="number">1000000</span>] - maximum allowed <span class="keyword">to</span> be analyzed <span class="keyword">for</span> highlighting. This maximum can be <span class="keyword">set</span> <span class="keyword">by</span> changing the [<span class="keyword">index</span>.highlight.max_analyzed_offset] <span class="keyword">index</span> level setting. <span class="keyword">For</span> large texts, indexing <span class="keyword">with</span> offsets <span class="keyword">or</span> term vectors <span class="keyword">is</span> recommended!<span class="string">"&#125;],"</span><span class="built_in">type</span><span class="string">":"</span>search_phase_execution_exception<span class="string">","</span>reason<span class="string">":"</span><span class="keyword">all</span> shards failed<span class="string">","</span>phase<span class="string">":"</span>query<span class="string">","</span>grouped<span class="string">":true,"</span>failed_shards<span class="string">":[&#123;"</span>shard<span class="string">":0,"</span><span class="keyword">index</span><span class="string">":"</span>filebeat<span class="number">-7.4</span><span class="number">.0</span><span class="number">-2019.10</span><span class="number">.16</span><span class="number">-000001</span><span class="string">","</span>node<span class="string">":"</span>H_Zq22spSJKz0RWR_alDsA<span class="string">","</span>reason<span class="string">":&#123;"</span><span class="built_in">type</span><span class="string">":"</span>illegal_argument_exception<span class="string">","</span>reason<span class="string">":"</span>The <span class="built_in">length</span> of [error.message] field of [JHzl020BgPENHIlNYRoc] doc of [filebeat<span class="number">-7.4</span><span class="number">.0</span><span class="number">-2019.10</span><span class="number">.16</span><span class="number">-000001</span>] <span class="keyword">index</span> has exceeded [<span class="number">1000000</span>] - maximum allowed <span class="keyword">to</span> be analyzed <span class="keyword">for</span> highlighting. This maximum can be <span class="keyword">set</span> <span class="keyword">by</span> changing the [<span class="keyword">index</span>.highlight.max_analyzed_offset] <span class="keyword">index</span> level setting. <span class="keyword">For</span> large texts, indexing <span class="keyword">with</span> offsets <span class="keyword">or</span> term vectors <span class="keyword">is</span> recommended!<span class="string">"&#125;&#125;],"</span>caused_by<span class="string">":&#123;"</span><span class="built_in">type</span><span class="string">":"</span>illegal_argument_exception<span class="string">","</span>reason<span class="string">":"</span>The <span class="built_in">length</span> of [error.message] field of [JHzl020BgPENHIlNYRoc] doc of [filebeat<span class="number">-7.4</span><span class="number">.0</span><span class="number">-2019.10</span><span class="number">.16</span><span class="number">-000001</span>] <span class="keyword">index</span> has exceeded [<span class="number">1000000</span>] - maximum allowed <span class="keyword">to</span> be analyzed <span class="keyword">for</span> highlighting. This maximum can be <span class="keyword">set</span> <span class="keyword">by</span> changing the [<span class="keyword">index</span>.highlight.max_analyzed_offset] <span class="keyword">index</span> level setting. <span class="keyword">For</span> large texts, indexing <span class="keyword">with</span> offsets <span class="keyword">or</span> term vectors <span class="keyword">is</span> recommended!<span class="string">","</span>caused_by<span class="string">":&#123;"</span><span class="built_in">type</span><span class="string">":"</span>illegal_argument_exception<span class="string">","</span>reason<span class="string">":"</span>The <span class="built_in">length</span> of [error.message] field of [JHzl020BgPENHIlNYRoc] doc of [filebeat<span class="number">-7.4</span><span class="number">.0</span><span class="number">-2019.10</span><span class="number">.16</span><span class="number">-000001</span>] <span class="keyword">index</span> has exceeded [<span class="number">1000000</span>] - maximum allowed <span class="keyword">to</span> be analyzed <span class="keyword">for</span> highlighting. This maximum can be <span class="keyword">set</span> <span class="keyword">by</span> changing the [<span class="keyword">index</span>.highlight.max_analyzed_offset] <span class="keyword">index</span> level setting. <span class="keyword">For</span> large texts, indexing <span class="keyword">with</span> offsets <span class="keyword">or</span> term vectors <span class="keyword">is</span> recommended!<span class="string">"&#125;&#125;&#125;,"</span>status<span class="string">":400&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>解决方法：<br>打开 Kibana –&gt; Management –&gt; Advanced Settings –&gt; Highlight results 开关关闭。</p>
<h3 id="关于-Filebeat-的一些使用心得"><a href="#关于-Filebeat-的一些使用心得" class="headerlink" title="关于 Filebeat 的一些使用心得"></a>关于 Filebeat 的一些使用心得</h3><p><strong>1. yum 方式安装的 Filebeat 其日志如何查看？</strong></p>
<ol>
<li>journalctl -u filebeat -f</li>
<li>tail -f  /var/log/filebeat/filebeat</li>
</ol>
<p><strong>2. Filebeat 状态清理：清理 registry </strong><br>有时候我们需要清理下 Filebeat 状态，从头开始读取日志，yum 方式安装的 filebeat 直接清理 /var/lib/filebeat/registry 文件夹即可。</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="https://xiezefan.me/2017/04/09/elk_in_action_grok_start/" target="_blank" rel="noopener">https://xiezefan.me/2017/04/09/elk_in_action_grok_start/</a> | Grok 简易入门<br><a href="https://github.com/elastic/logstash/blob/v1.4.2/patterns/grok-patterns" target="_blank" rel="noopener">https://github.com/elastic/logstash/blob/v1.4.2/patterns/grok-patterns</a> | Grok 本身支持的模式列表<br><a href="https://churrops.io/2018/06/18/elastic-modulo-mysql-do-filebeat-para-capturar-slowlogs-slow-queries/" target="_blank" rel="noopener">https://churrops.io/2018/06/18/elastic-modulo-mysql-do-filebeat-para-capturar-slowlogs-slow-queries/</a><br><a href="https://discuss.elastic.co/t/filebeat-mysql-module-slowlog-error-message-provided-grok-expressions-do-not-match-field-value/135945" target="_blank" rel="noopener">https://discuss.elastic.co/t/filebeat-mysql-module-slowlog-error-message-provided-grok-expressions-do-not-match-field-value/135945</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/07/基于-Kubernetes-的-7-大-DevOps-关键实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/07/基于-Kubernetes-的-7-大-DevOps-关键实践/" itemprop="url">基于 Kubernetes 的 7 大 DevOps 关键实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-07T20:34:38+08:00">
                2019-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍 DevOps 的 7 大关键实践在 Kubernetes 平台下如何落地，结合我们目前基于 Kubernetes 平台的 DevOps 实践谈谈是如何贯彻相关理念的，这里不会对其具体实现细节进行深入讲解，只做一个大致的概括的描述，分享下已有的实践，具体实践细节有时间了会单独整理一篇文章分享。</p>
<h3 id="DevOps-简介"><a href="#DevOps-简介" class="headerlink" title="DevOps 简介"></a>DevOps 简介</h3><p>DevOps 集文化理念、实践和工具于一身，可以提高企业高速交付应用程序和服务的能力，与使用传统软件开发和基础设施管理流程相比，能够帮助企业更快地发展和改进产品。</p>
<p><img src="/images/devops.png" alt=""></p>
<h5 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h5><p>The goals of DevOps span the entire delivery pipeline. They include:</p>
<ul>
<li>Improved deployment frequency;</li>
<li>Faster time to market;</li>
<li>Lower failure rate of new releases;</li>
<li>Shortened lead time between fixes;</li>
<li>Faster mean time to recovery (in the event of a new release crashing or otherwise disabling the current system).</li>
</ul>
<h3 id="DevOps-的-7-大关键实践在Kubernetes-平台下的落地"><a href="#DevOps-的-7-大关键实践在Kubernetes-平台下的落地" class="headerlink" title="DevOps 的 7 大关键实践在Kubernetes 平台下的落地"></a>DevOps 的 7 大关键实践在Kubernetes 平台下的落地</h3><p>下面为基于 Kubernetes 的 CI/CD  流水线整体实践，使用 Kubernetes + Docker + Jenkins + Helm 等云原生工具链来构建 CI/CD 管道，基于 Google Cloud Platform 云平台构建：</p>
<p><img src="/images/k8s-devops-ci-cd.png" alt=""><br><strong>1. Configuration Management</strong><br>关于配置文件的管理我们统一使用 Kubernetes 提供的 configmap 和 secret 资源对象来实现，对于一般的应用配置使用 configmap 管理，对于敏感数据使用 secret 存储。</p>
<p><strong>2. Release Management</strong><br>关于发布管理，使用 Helm 工具统一以 Chart 的方式打包并发布应用，维护每个微服务的历史版本，可以按需回滚。应用的镜像版本统一存储到一个 Docker 私服。</p>
<p><strong>3. Continuous Integration</strong><br>关于持续集成整合了一套完全开源的工具链：Gitlab + Maven + Jenkins + TestNg + SonarQuebe + Allure。Jenkins 运行在 Kubernetes 集群中，所有的工具链都以容器的方式运行，按需定义并使用，无需单独安装维护。<br><img src="/images/k8s-ci-jenkins-pipeline.png" alt=""></p>
<p><strong>4. Continuous Deployment</strong><br>关于持续部署方面做的不是很好，没有形成完整的 Pipeline，整个自动化 Pipeline 进行到预发布环境，对于生产环境发布，研发人员自助式点击另一个单独的部署 Pipeline Job 进行部署，选择镜像版本进行发布。<br><img src="/images/k8s-cd-jenkins-pipeline.png" alt=""></p>
<p><strong>5. Infrastructure as Code</strong><br>基础架构即代码的指的是所有软件基础设施的管理维护都以代码的方式管理起来，对于基础设施资源的创建、销毁、变更，不再是人工通过界面化点触式管理，所有这些更改都基于代码的提交变更和一套自动化框架。比如知名的 Terraform 就是一个业界比较流行的 IaC 框架，专门用于代码化管理云基础设施。在 Infrastructure as Code 方面，其实 Kubernetes 完全契合这一点，所有的基础架构及应用服务都可以被抽象成 API 资源对象，我们只需要按需定义 yaml 资源文件即可快速生成相应的资源。比如我们需要一个 Redis 中间件，那么只需要编写一个声明式 yaml 文件，定义需要的配置、版本等信息即可以容器的方式在 k8s 集群中运行起来。最终只需要在 git 代码仓库维护这些 yaml 文件即可。<br><img src="/images/k8s-iac.png" alt=""></p>
<p><strong>6. Test Automation</strong><br>关于测试自动化，目前主要有三种类型的测试：单元测试、后端接口测试、UI 自动化测试。所有的这些测试都集成在 Jenkins pipeline 中。后端接口测试和 UI 测试除了在自动化 Pipeline 中运行，还会每天定时跑测试，最终的测试报告统一收集到 Reportportal 报表平台。<br><img src="/images/rp_dashboard.png" alt=""></p>
<p><strong>7. Application Performance Monitoring</strong><br>关于应用监控采用云原生架构下的最佳实践： Prometheus 监控栈<br><img src="/images/prometheus-arch.png" alt=""></p>
<p>关于日志采集基于 EFK 技术栈<br><img src="/images/k8s-efk-arch.png" alt=""></p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://www.wikiwand.com/en/DevOps#/Definitions_and_history" target="_blank" rel="noopener">https://www.wikiwand.com/en/DevOps#/Definitions_and_history</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/05/Kubernetes-基于-EFK-技术栈的日志收集实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/05/Kubernetes-基于-EFK-技术栈的日志收集实践/" itemprop="url">Kubernetes 基于 EFK 技术栈的日志收集实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-05T23:54:59+08:00">
                2019-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前写过一篇文章介绍了容器环境下日志管理的原理机制：<a href="https://blog.csdn.net/qianghaohao/article/details/100072538" target="_blank" rel="noopener">从 Docker 到 Kubernetes 日志管理机制详解</a>，文章内容偏理论，本文在该理论的支撑下具体实践 Kubernetes 下基于 EFK 技术栈的日志收集，本文偏实践，要想全面了解 Kubernetes 下日志收集管理机制，最好还是两篇文章顺序阅读。</p>
<p>本文不仅限于介绍怎么在 Kubernetes 集群部署 EFK 组件，还涉及到其他相关话题：EFK 组件简介、Kubernetes 环境下为什么选用 EFK 优于 ELK 组件、Fluentd 简介、Fluentd 工作机制等等。本文结构如下：</p>
<ul>
<li>EFK 组件简介</li>
<li>Kubernetes 环境下为什么选用 EFK 优于 ELK 组件</li>
<li>Fluentd 简介</li>
<li>Fluentd 工作机制</li>
<li>Fluentd 配置的核心指令</li>
<li>Kubernetes EFK 日志收集架构</li>
<li>Kubernetes EFK 日志收集架构实践</li>
</ul>
<h3 id="EFK-组件简介"><a href="#EFK-组件简介" class="headerlink" title="EFK 组件简介"></a>EFK 组件简介</h3><p><img src="/images/EFK.png" alt=""><br>顾名思义，EFK 是 Elasticsearch、Fluentd、Kibana 三个开源软件组件的首字母缩写，EFK 是业界主流的容器时代日志收集处理的最佳解决方案。Fluentd 是一个日志收集器，负责从各个服务器节点抓取日志。Elasticsearch 是一个搜索存储引擎，可以存储 Fluentd 收集的日志，并提供查询服务。Kibana 是 Elasticsearch 的一个界面化组件，提供 UI 方式查询 Elasticsearch 存储的数据。三个组件组合起来工作就是 EFK，组件之间数据流是这样：Log 源（比如 Log 文件、k8s Pod 日志、Docker 日志驱动等等）—&gt; Fluentd 收集 —&gt; Elasticsearch 存储 —&gt; Kibana UI 查看。</p>
<h3 id="Kubernetes-环境下为什么选用-EFK-优于-ELK-组件"><a href="#Kubernetes-环境下为什么选用-EFK-优于-ELK-组件" class="headerlink" title="Kubernetes 环境下为什么选用 EFK 优于 ELK 组件"></a>Kubernetes 环境下为什么选用 EFK 优于 ELK 组件</h3><p>ELK 是 Elasticsearch、Logstash、Kibana 三个开源组件的缩写，可以看出和 EFK 的区别在于第二个字母，一个是 Logstash，一个是 Fluentd。</p>
<p>我们很早之前使用 ELK 技术栈收集云主机上部署的应用日志，每台虚拟主机部署一个 Logstash 实例收集应用程序目录日志，然后统一传输到一个 Logshtash 中央处理节点，处理后的数据存储到 Elasticsearch。这种方案虽然可以实现日志的统一收集处理，但是 Logstash 比较吃系统资源，基本上资源占用堪比一个 Java 微服务，一个简单的抓取节点就大概需要 1 GB 的内存，我们知道云主机的机器资源是非常昂贵的，所以这种方案对资源浪费比较大，不是很推荐。之前我们基于该 ELK 方案的日志收集大致架构图如下：收集大概 13 个微服务日志，其中 Logstash Server 端平均内存使用能达到 8GB +，显然 Logstash 比较重量级，对系统资源的消耗可见一斑。<br><img src="/images/ELK.png" alt=""><br>从上面的实践案例可以知道 ELK 技术栈的缺陷在于 Log 收集器 Logstash 比较重量级，对系统资源消耗比较大。那么有没有更加轻量级的替代方案呢？答案是有的，比如 Elastic 的 beats 家族的 Filebeat 就可以取代 Logstash 作为日志抓取器，还有 Fluentd 也可以作为 Logstash 替代品，Fluentd 也是本文要讲的重头戏。为什么我们选用 Fluentd 而不用 Filebeat 呢，个人认为 Fluentd 兼具日志抓取、收集、处理、轻量级的特性，拥有丰富的插件生态，是日志解决方案的神器。而 Filebeat 功能重点在于日志的抓取、轻量级，但是对于日志的处理功能不是很强大。</p>
<p>Fluentd 的轻量级体现在它本身核心代码是用 C 语言编写，更接近操作系统底层语言，所以一般性能是比较高的，据官方介绍 30～40 MB 内存就能处理 13000 日志事件/秒/核，由此可见其性能是多么强大，所以对比 Logstash 而言，用 30 MB 内存就能解决的问题当然选择 Fluentd 了。</p>
<h3 id="Fluentd-简介"><a href="#Fluentd-简介" class="headerlink" title="Fluentd 简介"></a>Fluentd 简介</h3><p><a href="https://www.fluentd.org/" target="_blank" rel="noopener">Fluentd</a> 是一个开源的日志收集器，它统一了日志的收集和处理逻辑，多种不同来源的日志都可以通过 Fluentd 这个单一的工具统一收集，然后统一存储到单个或多个存储后端。</p>
<p>像很早之前没有类似 Fluentd 之类的工具的话，为了收集日志可能会有各种五花八门的方法（工具），比如：Shell 脚本分析日志文件、服务器 syslog 收集、rsync 定时同步，scp 拷贝日志文件到统一的存储服务器等等，这么做显然带来的问题是我们要维护各种日志收集端工具，由于各种工具使用上不统一，对整个日志系统的维护人员来说不亚于一场灾难。我们可以用一张图来描述这种复杂、错乱的场景：<br><img src="/images/before-fluentd.png" alt=""><br>针对上述存在的问题，Fluentd 插件式架构很好地解决了该问题，所有数据收集端和存储端都可以通过 Fluentd 使用不同的插件统一起来，这么做带来的最大好处就是大大简化了日志收集的架构，整个架构都以 Fuentd 为核心，不再需要维护人员掌握、维护各种乱七八糟的小工具。上面复杂、错乱的数据收集架构就可以简化为以 Fluentd 为核心的简单架构了：<br><img src="/images/after-fluentd.png" alt=""><br>关于 Fluentd 更多的介绍见官方文档：<a href="https://docs.fluentd.org/" target="_blank" rel="noopener">https://docs.fluentd.org/</a> 。</p>
<h3 id="Fluentd-工作机制"><a href="#Fluentd-工作机制" class="headerlink" title="Fluentd 工作机制"></a>Fluentd 工作机制</h3><p>Fluentd 和其他日志收集器的工作原理类似，对数据的处理流程也分为三大阶段：收集—&gt;处理、过滤—&gt;输出。这三个处理阶段都有不同的插件支持，可以灵活组合。在 Fluentd 中事件是 整个数据流处理的基本单位，fluentd 的 input 插件每接收到一条日志都会将其封装成一个 fluentd 事件，然后发送给 fluentd 引擎处理，fluentd 引擎根据事件中包含的 tab 匹配不同的 filter 插件进行事件的处理，处理完后发送到 output 插件，output 插件根据事件中的 tag 匹配事件，将匹配到的事件发送到对应的后端。</p>
<p>Fluentd 事件由三部分组成：</p>
<ul>
<li>tag: <code>.</code> 分隔的字符串，供 fluentd 路由引擎路由使用；</li>
<li>time: 由输入插件指定的事件发生的时间戳，必须符合 Unix 时间格式；</li>
<li>record: 日志内容；</li>
</ul>
<p><img src="/images/fluentd-workflow.png" alt=""></p>
<h3 id="Fluentd-配置的核心指令"><a href="#Fluentd-配置的核心指令" class="headerlink" title="Fluentd 配置的核心指令"></a>Fluentd 配置的核心指令</h3><p>上面简单介绍了下 Fluentd 对日志数据的处理流程，其是在这个流程中 Fluentd 的行为是通过其配置文件定义的，配置文件由一条条指令组成。下面是 Fluentd 配置文件的 6 大指令，是 Fluentd 配置的核心指令：</p>
<ul>
<li><code>source</code> directives determine the input sources.</li>
<li><code>match</code> directives determine the output destinations.</li>
<li><code>filter</code> directives determine the event processing pipelines.</li>
<li><code>system</code> directives set system wide configuration.</li>
<li><code>label</code> directives group the output and filter for internal<br>routing</li>
<li><code>@include</code> directives include other files.</li>
</ul>
<p>关于每条指令在具体配置文件中如何使用这里不再赘述，详情见：<a href="https://docs.fluentd.org/configuration/config-file" target="_blank" rel="noopener">https://docs.fluentd.org/configuration/config-file</a></p>
<h3 id="Kubernetes-EFK-日志收集架构"><a href="#Kubernetes-EFK-日志收集架构" class="headerlink" title="Kubernetes EFK 日志收集架构"></a>Kubernetes EFK 日志收集架构</h3><p>之前介绍过 Kubernetes 日志管理机制：再 k8s 每个节点上，kubelet 会为每个容器的日志创建一个软链接，软连接存储路径为：/var/log/containers/，软连接会链接到 /var/log/pods/ 目录下相应 pod 目录的容器日志，被链接的日志文件也是软链接，最终链接到 Docker 容器引擎的日志存储目录：/var/lib/docker/container 下相应容器的日志。所以 /var/log 和 /var/lib/docker/container 目录是整个节点所有容器日志的统一存储地方，这就为 Fluentd 日志收集提供了很大的方便。</p>
<p>针对上述 k8s 日志管理机制，Kubernetes 官方给出了推荐的日志收集方案：以 DaemonsSet 的方式在 k8s 集群每个节点部署一个节点级的 Fluentd 日志收集器，Fluentd Pod  在启动时挂载了宿主机的 /var/log 和 /var/lib/docker/container 目录，因此可以直接对宿主机目录中的容器日志读取并传输到存储后端：Elasticsearch。然后 Kibana 和 Elasticsearch 对接即可实时查看收集到的日志数据。<br><img src="/images/k8s-efk-arch.png" alt=""></p>
<h3 id="Kubernetes-EFK-日志收集架构实践"><a href="#Kubernetes-EFK-日志收集架构实践" class="headerlink" title="Kubernetes EFK 日志收集架构实践"></a>Kubernetes EFK 日志收集架构实践</h3><p>上面介绍了 Kubernetes EFK 日志收集架构，本节基于该架构进行实践。我们使用 Kubernetes 官方提供的 EFK 组件 mainfest 文件进行部署，Github 仓库目录为：<br><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch</a></p>
<p>该目录下存储了 EFK 三大组件的部署 yaml 资源文件，有两点需要说明下：</p>
<ul>
<li>Elasticsearch 数据持久化：默认 EmptyDir 的方式，这种方式在 Pod 重新调度后数据会丢失，不过为了实验，所以在这里就不进行修改了，使用默认的即可；</li>
<li>Kibana deployment 文件需要修改下：去掉 SERVER_BASEPATH 环境变量，要不然部署后访问会 404；</li>
</ul>
<h4 id="Kubernetes-EFK-部署"><a href="#Kubernetes-EFK-部署" class="headerlink" title="Kubernetes EFK 部署"></a>Kubernetes EFK 部署</h4><p>进入 fluentd-elasticsearch 目录，执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  create -f .</span><br></pre></td></tr></table></figure></p>
<p>查看 Pod 状态，确保每个组件启动成功，一般都会启动成功的，这里基本没什么坑。</p>
<h4 id="Kibana-对外访问"><a href="#Kibana-对外访问" class="headerlink" title="Kibana 对外访问"></a>Kibana 对外访问</h4><p>接下来将 Kibana 服务从 Kubernetes 集群对外暴露出来，实现对外访问，我们使用 Kong 网关对外暴露服务。具体 Kong 网关在 Kubernetes 的使用在这里不再赘述，如想了解见这里：<a href="https://blog.csdn.net/qianghaohao/article/category/9228448" target="_blank" rel="noopener">Kong 微服务网关在 Kubernetes 的实践</a>。</p>
<p>Konga 配置 Kibana 服务对外访问：</p>
<ol>
<li>创建 kibana-logging Kong Service<br><img src="/images/kibana-konga1.png" alt=""></li>
<li>创建 Kong 路由到 kibana-logging Kong Service<br><img src="/images/kibana-konga2.png" alt=""><br><img src="/images/kibana-konga3.png" alt=""></li>
</ol>
<p>kibnana.kong.com 绑定 host 到集群节点 IP 即可访问查看收集的日志：<br><img src="/images/efk-kibana.png" alt=""></p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/logging/</a> | Kubernetes 日志架构<br><a href="https://www.fluentd.org/architecture" target="_blank" rel="noopener">https://www.fluentd.org/architecture</a> | What is fluentd?<br><a href="https://docs.fluentd.org/quickstart/life-of-a-fluentd-event" target="_blank" rel="noopener">https://docs.fluentd.org/quickstart/life-of-a-fluentd-event</a> | Life of a Fluentd event</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/30/Kubernetes-CronJob-的一个应用案例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/30/Kubernetes-CronJob-的一个应用案例/" itemprop="url">Kubernetes CronJob 的一个应用案例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-30T11:25:17+08:00">
                2019-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近 Kubernetes 集群中出现过几次 Redis 故障，具体表现是每次集群重启（云资源按需启动）， Redis Pod 都要老半天才能启动起来，后来逐渐排查定位才发现原来是由于 Redis 开启了 aof 持久化机制。</p>
<p>我们知道在 AOF 持久化机制下，Resdis 的每一条写命令都会被同步、并且追加的方式持久化的磁盘文件，当 Redis 由于意外故障时，下次重启就会原封不动地执行 AOF 文件中的命令来恢复 Redis。那么显然这种方式会带来一个问题是随着时间的推移 aof 文件体积会越来越大，每次 Redis 重启都要执行一遍 aof 持久化的命令，速度也会越来越慢，从而导致 Redis 启动变慢。</p>
<p>显然解决方法是怎么把 AOF 文件变小，丢弃没用的记录。Redis 有一条 <code>BGREWRITE</code> 命令就是解决这问题的，这条命令的工作原理是将当前 Redis 中的数据都导出成 Redis 写语句，然后生成新的 aof 文件，替换掉旧的。显然新的 aof 文件体积会原因小于长时间运行的旧的 aof 文件，因为新的 aof 只是当前 Redis 的数据恢复语句，只记录当前的状态。</p>
<p>由于我们 Redis 是运行在 Kubernetes 集群中，所以借助于 Kubernetes 的 CronJob 机制定期执行 Redis <code>BGREWRITE</code> 命令来重写 aof 文件，从而缩小文件体积。</p>
<h3 id="Kubernetes-CronJob-简介"><a href="#Kubernetes-CronJob-简介" class="headerlink" title="Kubernetes CronJob 简介"></a>Kubernetes CronJob 简介</h3><p>Kubernetes CronJob 资源用来定义一些需要定时执行的任务，类似于 Linux/Unix 的 Crontab。CronJob 资源创建后会按照写的定时任务规则启动 Pod 执行定义的任务。关于 CronJob 更详细的信息见这里：<a href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs</a></p>
<h3 id="基于-k8s-CronJob-定期-AOF-重写"><a href="#基于-k8s-CronJob-定期-AOF-重写" class="headerlink" title="基于 k8s CronJob 定期 AOF 重写"></a>基于 k8s CronJob 定期 AOF 重写</h3><p>定义 CronJob 资源文件，每两小时进行一次 Redis AOF 重写，资源文件如下：<br>redis-cron.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span> <span class="comment">#for API server versions &gt;= 1.8.0 use batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">redis-bgrewriteaof-cron</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">redis-bgrewriteaof-cron</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  schedule:</span> <span class="string">"0 */2 * * *"</span></span><br><span class="line"><span class="attr">  successfulJobsHistoryLimit:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  failedJobsHistoryLimit:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  concurrencyPolicy:</span> <span class="string">Forbid</span></span><br><span class="line"><span class="attr">  startingDeadlineSeconds:</span> <span class="number">120</span></span><br><span class="line"><span class="attr">  jobTemplate:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      template:</span></span><br><span class="line"><span class="attr">        spec:</span></span><br><span class="line"><span class="attr">          containers:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">            image:</span> <span class="string">docker.io/bitnami/redis:4.0.12</span></span><br><span class="line"><span class="attr">            env:</span></span><br><span class="line"><span class="attr">              - name:</span> <span class="string">REDIS_PASSWORD</span></span><br><span class="line"><span class="attr">                valueFrom:</span></span><br><span class="line"><span class="attr">                  secretKeyRef:</span></span><br><span class="line"><span class="attr">                    name:</span> <span class="string">redis-test</span></span><br><span class="line"><span class="attr">                    key:</span> <span class="string">redis-password</span></span><br><span class="line"><span class="attr">            args:</span> <span class="string">[redis-cli,</span> <span class="bullet">-h,</span> <span class="string">redis-stage-master,</span> <span class="bullet">-a,</span> <span class="string">$(REDIS_PASSWORD),</span> <span class="string">BGREWRITEAOF]</span></span><br><span class="line"><span class="attr">          restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure></p>
<p>关于上面资源里面的一些配置项含义在此不做具体介绍，很多都能看懂，具体每个配置项含义看官方文档，都有详细的解释。这里有一点需要「特别注意」的是 redis<br>容器的 <code>args</code> 字段引用环境变量的方法：<br>比如这里引用了 REDIS_PASSWORD 环境变量，需要写成：<code>$(REDIS_PASSWORD)</code> 这样的方式引用，而不能写成：$REDIS_PASSWORD 或者 ${REDIS_PASSWORD}。</p>
<p>执行 <code>kubectl create</code> 创建定义的 CronJob 资源<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f redis-cron.yaml -n <span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>查看 CronJob 执行情况<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get cronjob -n <span class="built_in">test</span></span><br><span class="line">NAME                      SCHEDULE      SUSPEND   ACTIVE    LAST SCHEDULE   AGE</span><br><span class="line">redis-bgrewriteaof-cron   0 */2 * * *   False     0         1h              14h</span><br></pre></td></tr></table></figure></p>
<p>可以看出最近一小时前已经调度过一次，如果要看调度是否成功可以看对应 Pod 的 log，也可以 <code>kubectl get jobs -n test</code> 查看启动的 Job 的状态。</p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs</a> | Running Automated Tasks with a CronJob<br><a href="https://redis.io/commands/bgrewriteaof" target="_blank" rel="noopener">https://redis.io/commands/bgrewriteaof</a> | Redis之AOF重写及其实现原理</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/29/数据库升级-DevOps-落地实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/29/数据库升级-DevOps-落地实践/" itemprop="url">数据库升级 DevOps 落地实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-29T11:01:48+08:00">
                2019-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在我们做持续集成/交付的过程中，应用的发布已经通过 DevOps 流水线基本能满足快速迭代的需求，但是很多企业在落地实践 DevOps 的过程中很容易忽略的一点是关于应用数据库版本、升级的管理，每次上线发布数据库的更新依然通过运维或者 DBA 手工更新，在微服务、容器盛行的背景下，服务多，服务发布速度快，显然靠人工该 DB 是跟不上迭代速度的，从而导致 DB 的更新成了整个软件交付周期的瓶颈。这一点我是深有体会，尤其是每次上线时，多个微服务同时上线，同时还需要进行 DB 升级，这个时候研发人员会给我们 SQL 执行，当然研发人员的数量是远远多于开发人员，所以每次上线运维人员经常陷入被”围堵“的尴尬境地。当然还存在其他种种痛点，大概总结下有如下痛点：</p>
<ul>
<li>DB 的升级人工执行跟不上版本发布速度，成为软件交付的瓶颈；</li>
<li>人工执行 DB 升级错误率比自动化执行更容易出错；</li>
<li>各个环境 DB 没有统一的版本管理，经常会出现这个 SQL 有没有在某个环境执行的疑问；</li>
<li>环境之间数据脚本同步经常出现遗漏的情况，由于开发或测试环境操作 DB 的人多，在应用从一个环境升级到另一个环境中经常忘记执行某条 SQL，然后导致各种问题故障。这种问题甚至在应用上线时也会频频出现，然后通知运维或 DBA 执行遗漏 SQL；</li>
</ul>
<p>那么在 DevOps 落地实践中如何很好地处理好数据库升级这一环呢，从而解决上述存在的种种痛点，不要让数据库升级成为软件交付的瓶颈，使得数据库的升级流程融入自动化流水线。我调研了下业界关于应用 DB 升级的方案，不少文章或者圈内人士推崇专门的数据库管理工具版本化管理，自动化执行，比如 <a href="https://flywaydb.org/" target="_blank" rel="noopener">Flyway</a>，<a href="https://www.liquibase.org/" target="_blank" rel="noopener">Liquibase</a> 等著名的工具，都是专业的数据库版本管理和自动化工具。</p>
<p>在本文中主要介绍如何将 Flyway 和其他 DevOps 工具链整合，实现 DB 升级的自动化和管理的版本化，从而解决之前存在的一系列痛点。本文用到的工具链有：Flyway + Jenkins 2.0（Pipeline 脚本）+ Gitlab + MySQL。需要说明的一点是本文并不是一步步讲解各种工具链如何使用和相关介绍，重点在于工具链的整合实践，以及如何恰当地应用。在文末附有完整的 Pipeline 实现脚本，仅供参考！</p>
<h3 id="数据库升级-DevOps-实践带来了什么收益"><a href="#数据库升级-DevOps-实践带来了什么收益" class="headerlink" title="数据库升级 DevOps 实践带来了什么收益"></a>数据库升级 DevOps 实践带来了什么收益</h3><p>其实在文章开言已经说清楚了，总结起来就两点：</p>
<ul>
<li>所有环境数据库版本统一管理；</li>
<li>数据库升级变更自动化；</li>
</ul>
<h3 id="实践方案概要"><a href="#实践方案概要" class="headerlink" title="实践方案概要"></a>实践方案概要</h3><p>数据库升级脚本统一按微服务模块以独立 git 仓库的形式管理起来，每次版本迭代，规划好 SQL 模型定义（DDL），将 db 脚本签入独立的 git 仓库，然后使用专门的数据库版本管理工具自动扫描仓库目录的 db 升级脚本，由于 db 升级脚本文件名称符合一定的命名规范，所以工具可以自动按版本号顺序执行脚本，并且已经执行过的脚步文件再次执行会忽略。关于 DB 升级工具的选择，我们选用 Flyway，功能单一、容易上手，以规约优于配置的思想规范 DB 的版本化管理，我们写的 SQL 脚本文件都必须符合 Flyway 的文件名命名规范，这样才能在升级过程中生效。</p>
<h3 id="具体实践"><a href="#具体实践" class="headerlink" title="具体实践"></a>具体实践</h3><p>借助的工具链：Flyway + Jenkins 2.0（Pipeline 脚本）+ Gitlab + MySQL(Google Cloud SQL)</p>
<p><img src="/images/flyway-devops.png" alt=""></p>
<ol>
<li>以微服务应用 git 工程名称在 gitlab 一个单独的组创建 db 代码工程；</li>
<li>在 db 代码工程中创建以数据库命名的目录，存放对应数据库升级的脚本文件，脚本文件名称需要符合 FlywayDB 的命名规范：<br><img src="/images/flyway-file-version.png" alt=""></li>
<li>db 代码工程分支管理：dev 环境对应 dev 分支，test 环境对应 test 分支，stage 环境对应 stage 分支，生产环境对应 master 分支；</li>
<li>Jenkins 脚本注册相应代码工程名称和对应 db 名称；</li>
<li>点击 Jenkins 执行数据库升级；</li>
</ol>
<h3 id="强制规约"><a href="#强制规约" class="headerlink" title="强制规约"></a>强制规约</h3><ol>
<li>gitlab 代码工程名称和 db 工程名称一致，db 工程目录下文件夹以数据库名称命名；</li>
<li>db 脚本名称符合 FlywayDB 命名规范；</li>
<li>db 脚本文件版本名统一大于 1.0，比如: 可以是 V1.0.1，但不能是 V0.2.3；</li>
<li>db 脚本内容为 DDL 语句，不能包含 DML 或者 DCL 语句，这个要严格审核，因为 DML 和 DCL 版本追踪没意义，而且各个环境可能还不兼容，FlywayDB 的本质是数据库 Sechma 版本管理，只关心表结构，表里面的数据不关心。关于数据库 DDL、DML、DCL 相关概念及区别见<a href="https://www.cnblogs.com/zhangmingcheng/p/5295684.html" target="_blank" rel="noopener">这里</a>；</li>
<li>已经执行过的 db 脚本不能修改后重复执行，并且执行过的 db 脚本文件需要原封不动保留，不能丢失和修改，否则升级会失败，这个一定要注意。如果对已经执行的 db 脚本不满意，有改动需要变更，则新加 db 脚本文件，可以小版本号比原先增 1，相当于临时 fix，但是我们尽量减少这种情况的发生；</li>
</ol>
<h3 id="具体-Workflow"><a href="#具体-Workflow" class="headerlink" title="具体 Workflow"></a>具体 Workflow</h3><h4 id="开发人员-Workflow"><a href="#开发人员-Workflow" class="headerlink" title="开发人员 Workflow"></a>开发人员 Workflow</h4><p>开发、测试、预发布环境开发人员点击 Jenkins job 执行数据库升级：</p>
<ol>
<li>将 SQL 脚本按照 FlywayDB 规范提交到对应的 db 仓库，提交 MR 到对应分支；</li>
<li>小组 db 脚本审核人审核没问题后合并 db 代码；</li>
<li>小组成员点击 Jenkins Job，执行数据库升级<br>3.1 选择环境+服务名称+要升级的数据库名称<br><img src="/images/flyway-devops-workflow-dev1.jpeg" alt=""><br>3.2 运行 Job<br><img src="/images/flyway-devops-workflow-dev2.jpeg" alt=""></li>
</ol>
<h4 id="运维人员-Workflow"><a href="#运维人员-Workflow" class="headerlink" title="运维人员 Workflow"></a>运维人员 Workflow</h4><p>运维人员只负责线上 SQL 的升级：</p>
<ol>
<li>开发人员告知运维人员本次上线 db 脚本已提交到代码仓库并 merge 到 master 分支；</li>
<li>运维人员点击 Jenkins Job 执行相应服务的数据库升级：<br>2.1 选择服务名称+要升级的数据库名称<br><img src="/images/flyway-devops-workflow-ops1.jpeg" alt=""><br>2.2 运行 Job，Pipeline 会阻塞在确认节点，做最后的审查<br><img src="/images/flyway-devops-workflow-ops2.jpeg" alt=""><br>2.3 Job 执行完成<br><img src="/images/flyway-devops-workflow-ops3.jpeg" alt=""></li>
</ol>
<h4 id="Workflow-举例"><a href="#Workflow-举例" class="headerlink" title="Workflow 举例"></a>Workflow 举例</h4><ol>
<li><p>新建一个 gitlab 工程，专门存放 db 脚本：<br>服务名称假设为 db-migration-demo，db 名称为 demo，仓库里面存放的 SQL 脚本如下：<br><img src="/images/flyway-devops-example1.png" alt=""></p>
</li>
<li><p>git 提交代码，然后点击 Jenkins Job，执行数据库升级<br><img src="/images/flyway-devops-example2.png" alt=""></p>
</li>
</ol>
<h3 id="关于-Pipeline-设计的两个功能点"><a href="#关于-Pipeline-设计的两个功能点" class="headerlink" title="关于 Pipeline 设计的两个功能点"></a>关于 Pipeline 设计的两个功能点</h3><h4 id="1-数据库整库备份策略"><a href="#1-数据库整库备份策略" class="headerlink" title="1. 数据库整库备份策略"></a>1. 数据库整库备份策略</h4><p>数据库 DDL 变更前整库备份一下是有必要的，但是每次变更都整库备份也不合理，因为可能某天上线，数据库升级比较集中，一天内会触发很多次备份，造成了资源的浪费。解决方案是给备份一个时间窗口（比如 2 小时），每次执行前判断下最近两小时是否有备份，如果没有则触发整库备份，这样就能避免每次执行 Job 都会触发整库备份。<br>具体解决方法：<br>获取当前时间减去两小时的时间，然后和上次整库备份的时间戳比较，如果前者大，说明最近两小时内没备份，然后自动触发整库备份，时间戳比较用 Shell 脚本实现：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># !/bin/bash</span></span><br><span class="line"></span><br><span class="line">t1=`date -d <span class="string">"<span class="variable">$1</span>"</span> +%s`</span><br><span class="line">t2=`date -d <span class="string">"<span class="variable">$2</span>"</span> +%s`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$t1</span> -ge <span class="variable">$t2</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"true"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"false"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<h4 id="2-每次变更前备份库下的所有表结构，同时记录下-FlywayDB-更改前后状态"><a href="#2-每次变更前备份库下的所有表结构，同时记录下-FlywayDB-更改前后状态" class="headerlink" title="2. 每次变更前备份库下的所有表结构，同时记录下 FlywayDB 更改前后状态"></a>2. 每次变更前备份库下的所有表结构，同时记录下 FlywayDB 更改前后状态</h4><p>表结构备份和 FlywayDB 更改前后状态信息都以制品的方式归到 Jenkins，这样可以随时在 Jenkins 界面查看相关信息，比如查看 Flyway 前后执行状态如何，点开制品页即可看到：<br><img src="/images/flyway-devops-artifact.jpeg" alt=""></p>
<p><img src="/images/flyway-devops-flywahystate.png" alt=""></p>
<h3 id="附：Pipeline-脚本实现"><a href="#附：Pipeline-脚本实现" class="headerlink" title="附：Pipeline 脚本实现"></a>附：Pipeline 脚本实现</h3><p>为例减小文章的篇幅，这里只贴下运维人员 Workflow 的 Jenkins pipeline 脚本，研发人员的和这个类似，只是一些小的改动。<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  parameters &#123;</span><br><span class="line">    //服务名称</span><br><span class="line">    choice(name:<span class="string">'serviceName'</span>, choices: [</span><br><span class="line">     <span class="string">'db-migration-demo'</span></span><br><span class="line">     ]</span><br><span class="line">    , description: <span class="string">'服务名称'</span>)</span><br><span class="line">    //数据库</span><br><span class="line">    choice(name:<span class="string">'dbName'</span>, choices: [</span><br><span class="line">     <span class="string">'demo'</span></span><br><span class="line">    ]</span><br><span class="line">    , description: <span class="string">'数据库名称'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  agent &#123;</span><br><span class="line">    kubernetes &#123;</span><br><span class="line">      label <span class="string">"sql-<span class="subst">$&#123;UUID.randomUUID().toString()&#125;</span>"</span></span><br><span class="line">      defaultContainer <span class="string">'jnlp'</span></span><br><span class="line">      yaml <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    some-label: db-imgration</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: flyway</span></span><br><span class="line"><span class="string">    image: boxfuse/flyway</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">    - cat</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">  - name: mysql-client</span></span><br><span class="line"><span class="string">    image: arey/mysql-client</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">    - cat</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">  - name: gcloud</span></span><br><span class="line"><span class="string">    image: google/cloud-sdk:alpine</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">    - cat</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  post &#123;</span><br><span class="line">      failure &#123;</span><br><span class="line">        echo <span class="string">"Database migration failed!"</span></span><br><span class="line">      &#125;</span><br><span class="line">      success &#123;</span><br><span class="line">        echo <span class="string">"Database migration success!"</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  options &#123;</span><br><span class="line">      gitLabConnection(<span class="string">'gitlab-connection'</span>)</span><br><span class="line">      //保持构建的最大个数</span><br><span class="line">      buildDiscarder(logRotator(numToKeepStr: <span class="string">'20'</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">'初始化'</span>) &#123;</span><br><span class="line">        steps &#123;</span><br><span class="line">          script &#123;</span><br><span class="line">            currentBuild.description = <span class="string">"production环境<span class="subst">$&#123;params.serviceName&#125;</span>服务<span class="subst">$&#123;params.dbName&#125;</span>库升级..."</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          container(<span class="string">'gcloud'</span>) &#123;</span><br><span class="line">            withCredentials([file(credentialsId: <span class="string">'cloudInfrastructureAccess'</span>, variable: <span class="string">'cloudSQLCredentials'</span>)]) &#123;</span><br><span class="line">              sh <span class="string">"gcloud auth activate-service-account <span class="subst">$&#123;env.cloudInfrastructureAccessSA&#125;</span> --key-file=<span class="subst">$&#123;cloudSQLCredentials&#125;</span> --project=<span class="subst">$&#123;env.gcpProject&#125;</span>"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          // 判断是否要进行数据库备份，如果两小时内没有备份则自动触发全量备份</span><br><span class="line">          script &#123;</span><br><span class="line">            isBackup = <span class="string">'false'</span></span><br><span class="line">            // 默认 jenkins 跑在 busybox 容器，获取时间和普通 Linux 发行版有点区别</span><br><span class="line">            date2HoursAgo = sh(returnStdout: true, script: <span class="string">"date -u +'%Y-%m-%d %H' -d@\"</span>\$((<span class="string">`date +%s`</span>-<span class="number">7200</span>))\<span class="string">""</span>).trim()</span><br><span class="line">            container(<span class="string">'gcloud'</span>) &#123;</span><br><span class="line">              latestDBBackupTime = sh(returnStdout: true, script: <span class="string">"gcloud sql backups list --instance=<span class="subst">$&#123;env.prodMySqlInstance&#125;</span> --limit=1 | grep -v 'WINDOW_START_TIME' | awk '&#123;print \$2&#125;' | awk -F ':' '&#123;print \$1&#125;'|sed 's/T/ /g'"</span>).trim()</span><br><span class="line">            &#125;</span><br><span class="line">            withCredentials([file(credentialsId: <span class="string">'time-compare.sh'</span>, variable: <span class="string">'timeCompare'</span>)]) &#123;</span><br><span class="line">              isBackup = sh(returnStdout: true, script: <span class="string">"sh <span class="subst">$&#123;timeCompare&#125;</span> \'$date2HoursAgo\' \'$latestDBBackupTime\'"</span>).trim()</span><br><span class="line">              echo <span class="string">"$date2HoursAgo"</span></span><br><span class="line">              echo <span class="string">"$latestDBBackupTime"</span></span><br><span class="line">              echo <span class="string">"$isBackup"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 如果两小时内没有备份则自动触发全量备份</span><br><span class="line">    stage(<span class="string">'整库智能备份'</span>) &#123;</span><br><span class="line">        <span class="keyword">when</span> &#123;</span><br><span class="line">          expression &#123; isBackup == <span class="string">'true'</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        steps &#123;</span><br><span class="line">          script &#123;</span><br><span class="line">            container(<span class="string">'gcloud'</span>) &#123;</span><br><span class="line">              // 列出最近 <span class="number">10</span> 个备份，便于观察</span><br><span class="line">              sh <span class="string">"gcloud sql backups list --instance=<span class="subst">$&#123;env.prodMysqlInstance&#125;</span> --limit=10"</span></span><br><span class="line">              backupTimestamp = sh(returnStdout: true, script: <span class="string">"date -u +'%Y-%m-%d %H%M%S'"</span>).trim()</span><br><span class="line">              backupDescription=<span class="string">"Flyway backuped at $backupTimestamp (UTC)"</span></span><br><span class="line">              // gcloud 创建 db 备份</span><br><span class="line">              sh <span class="string">"gcloud sql backups create --async --instance=<span class="subst">$&#123;env.prodMysqlInstance&#125;</span> --description=\'$backupDescription\'"</span></span><br><span class="line">              sh <span class="string">"gcloud sql backups list --instance=<span class="subst">$&#123;env.prodMysqlInstance&#125;</span> --limit=10"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stage(<span class="string">'表结构备份'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">"sql-secret-production"</span>, passwordVariable: <span class="string">'sqlPass'</span>, usernameVariable: <span class="string">'sqlUser'</span>)]) &#123;</span><br><span class="line">            container(<span class="string">'mysql-client'</span>) &#123;</span><br><span class="line">              sh <span class="string">"mysqldump -h <span class="subst">$&#123;env.prodMySqlHost&#125;</span> -u$sqlUser -p$sqlPass -d <span class="subst">$&#123;params.dbName&#125;</span> --single-transaction &gt; <span class="subst">$&#123;params.serviceName&#125;</span>-<span class="subst">$&#123;params.dbName&#125;</span>-`TZ=UTC-8 date +%Y%m%d-%H%M%S`-dump.sql"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 表结构备份同步到 gcs 存储桶</span><br><span class="line">        container(<span class="string">'gcloud'</span>) &#123;</span><br><span class="line">          sh <span class="string">"gsutil cp *-dump.sql <span class="subst">$&#123;env.gcsBackupBucket&#125;</span>/db/production/<span class="subst">$&#123;params.serviceName&#125;</span>/"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // jenkins 归档数据库备份，可在 BlueOcean 页面制品页查看</span><br><span class="line">        archiveArtifacts <span class="string">"*-dump.sql"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'拉取 db 脚本'</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">          checkout([$class: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">"master"</span>]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: <span class="string">'jenkins-deploy'</span>, url: <span class="string">"<span class="subst">$&#123;env.dbMigrationGitRepoGroup&#125;</span>/<span class="subst">$&#123;params.serviceName&#125;</span>"</span>]]])</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stage(<span class="string">'flyway migrate'</span>) &#123;</span><br><span class="line">      steps&#123;</span><br><span class="line">        script &#123;</span><br><span class="line">          host = <span class="string">"<span class="subst">$&#123;env.prodMySqlHost&#125;</span>"</span></span><br><span class="line">          timestamp = sh(returnStdout: true, script: <span class="string">"TZ=UTC-8 date +%Y%m%d-%H%M%S"</span>).trim()</span><br><span class="line">          flywayStateFile = <span class="string">"flyway-state-production-<span class="subst">$&#123;params.serviceName&#125;</span>-<span class="subst">$&#123;params.dbName&#125;</span>_<span class="subst">$&#123;timestamp&#125;</span>.txt"</span></span><br><span class="line"></span><br><span class="line">          container(<span class="string">'flyway'</span>) &#123;</span><br><span class="line">            withCredentials([usernamePassword(credentialsId: <span class="string">"sql-secret-production"</span>, passwordVariable: <span class="string">'sqlPass'</span>, usernameVariable: <span class="string">'sqlUser'</span>)])&#123;</span><br><span class="line">              sh <span class="string">"flyway -url=jdbc:mysql://<span class="subst">$&#123;host&#125;</span>/<span class="subst">$&#123;params.dbName&#125;</span>?useSSL=false -user=<span class="subst">$&#123;sqlUser&#125;</span> -password=<span class="subst">$&#123;sqlPass&#125;</span> -locations=filesystem:<span class="subst">$&#123;params.dbName&#125;</span> -baselineOnMigrate=true repair"</span></span><br><span class="line">              sh <span class="string">"echo \"[ flyway 升级前 db 状态 ]\" &gt; $flywayStateFile"</span></span><br><span class="line">              sh <span class="string">"flyway -url=jdbc:mysql://<span class="subst">$&#123;host&#125;</span>/<span class="subst">$&#123;params.dbName&#125;</span>?useSSL=false -user=<span class="subst">$&#123;sqlUser&#125;</span> -password=<span class="subst">$&#123;sqlPass&#125;</span> -locations=filesystem:<span class="subst">$&#123;params.dbName&#125;</span> -baselineOnMigrate=true info \</span></span><br><span class="line"><span class="string">                 | tee -a $flywayStateFile"</span></span><br><span class="line">              try &#123;</span><br><span class="line">                timeout(<span class="keyword">time</span>: <span class="number">8</span>, unit: <span class="string">'HOURS'</span>) &#123;</span><br><span class="line">                  env.isMigrateDB = input message: <span class="string">'确认升级 DB?'</span>,</span><br><span class="line">                  parameters: [choice(name: <span class="string">"isMigrateDB"</span>, choices: <span class="string">'Yes\nNo'</span>, description: <span class="string">"您当前选择要升级的是<span class="subst">$&#123;params.serviceName&#125;</span>服务<span class="subst">$&#123;params.dbName&#125;</span>库，确认升级？"</span>)]</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; catch (err) &#123;</span><br><span class="line">                sh <span class="string">"echo 'Exception!' &amp;&amp; exit 1"</span></span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (env.isMigrateDB == <span class="string">'No'</span>) &#123;</span><br><span class="line">                sh <span class="string">"echo '已取消升级!' &amp;&amp; exit 1"</span></span><br><span class="line">              &#125;</span><br><span class="line">              sh <span class="string">"flyway -url=jdbc:mysql://<span class="subst">$&#123;host&#125;</span>/<span class="subst">$&#123;params.dbName&#125;</span>?useSSL=false -user=<span class="subst">$&#123;sqlUser&#125;</span> -password=<span class="subst">$&#123;sqlPass&#125;</span> -locations=filesystem:<span class="subst">$&#123;params.dbName&#125;</span> -baselineOnMigrate=true migrate"</span></span><br><span class="line">              sh <span class="string">"echo \"\n\n[ flyway 升级后 db 状态 ]\" &gt;&gt; $flywayStateFile"</span></span><br><span class="line">              sh <span class="string">"flyway -url=jdbc:mysql://<span class="subst">$&#123;host&#125;</span>/<span class="subst">$&#123;params.dbName&#125;</span>?useSSL=false -user=<span class="subst">$&#123;sqlUser&#125;</span> -password=<span class="subst">$&#123;sqlPass&#125;</span> -locations=filesystem:<span class="subst">$&#123;params.dbName&#125;</span> -baselineOnMigrate=true info \</span></span><br><span class="line"><span class="string">                 | tee -a $flywayStateFile"</span></span><br><span class="line">              archiveArtifacts <span class="string">"$flywayStateFile"</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/26/从-Docker-到-Kubernetes-日志管理机制详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/26/从-Docker-到-Kubernetes-日志管理机制详解/" itemprop="url">从 Docker 到 Kubernetes 日志管理机制详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-26T09:36:40+08:00">
                2019-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在容器化时代，容器应用的日志管理和传统应用存在很大的区别，为了顺应容器化应用，Docker 和 Kubernetes 提供了一套完美的日志解决方案。本文从 Docker 到 Kubernetes 逐步介绍在容器化时代日志的管理机制，以及在 Kubernetes 平台下有哪些最佳的日志收集方案。涉及到的话题有 Docker 日志管理机制、Kubernetes 日志管理机制、Kubernetes 集群日志收集方案。本文结构如下：</p>
<ul>
<li><p>Docker 日志管理机制</p>
<ul>
<li>Docker 的日志种类</li>
<li>基于日志驱动（loging driver）的日志管理机制</li>
<li>Docker 日志驱动（loging driver）配置</li>
<li>Docker 默认的日志驱动 <code>json-file</code></li>
</ul>
</li>
<li><p>Kubernetes 日志管理机制</p>
<ul>
<li>应用 Pod 日志</li>
<li>Kuberntes 集群组件日志</li>
</ul>
</li>
<li><p>Kubernetes 集群日志收集方案</p>
<ul>
<li>节点级日志代理方案</li>
<li>sidecar 容器方案</li>
<li>应用程序直接将日志传输到日志平台</li>
</ul>
</li>
</ul>
<h3 id="Docker-日志管理机制"><a href="#Docker-日志管理机制" class="headerlink" title="Docker 日志管理机制"></a>Docker 日志管理机制</h3><h4 id="Docker-的日志种类"><a href="#Docker-的日志种类" class="headerlink" title="Docker 的日志种类"></a>Docker 的日志种类</h4><p>在 Docker 中日志分为两大类：</p>
<ul>
<li>Docker 引擎日志；</li>
<li>容器日志；</li>
</ul>
<h5 id="Docker-引擎日志"><a href="#Docker-引擎日志" class="headerlink" title="Docker 引擎日志"></a>Docker 引擎日志</h5><p>Docker 引擎日志就是 docker 服务的日志，即 <code>dockerd</code> 守护进程的日志，在支持 Systemd 的系统中可以通过 <code>journal -u docker</code> 查看日志。</p>
<p><img src="/images/docker-systemd.png" alt=""></p>
<h5 id="容器日志"><a href="#容器日志" class="headerlink" title="容器日志"></a>容器日志</h5><p>容器日志指的是每个容器打到 stdout 和 stderr 的日志，而不是容器内部的日志文件。docker 管理所有容器打到 stdout 和 stderr 的日志，其他来源的日志不归 docker 管理。我们通过 <code>docker logs</code> 命令查看容器日志都是读取容器打到 stdout 和 stderr 的日志。</p>
<h4 id="基于日志驱动（loging-driver）的日志管理机制"><a href="#基于日志驱动（loging-driver）的日志管理机制" class="headerlink" title="基于日志驱动（loging driver）的日志管理机制"></a>基于日志驱动（loging driver）的日志管理机制</h4><p>Docker 提供了一套通用、灵活的日志管理机制，Docker 将所有容器打到 stdout 和 stderr 的日志都统一通过日志驱动重定向到某个地方。</p>
<p>Docker 支持的日志驱动有很多，比如 local、json-file、syslog、journald 等等，类似插件一样，不同的日志驱动可以将日志重定向到不同的地方，这体现了 Docker 日志管理的灵活性，以热插拔的方式实现日志不同目的地的输出。</p>
<p>Dokcer 默认的日志日志驱动是 <code>json-file</code>，该驱动将将来自容器的 stdout 和 stderr  日志都统一以 <code>json</code> 的形式存储到本地磁盘。日志存储路径格式为：<code>/var/lib/docker/containers/&lt;容器 id&gt;/&lt;容器 id&gt;-json.log</code>。所以可以看出在 <code>json-file</code> 日志驱动下，Docker 将所有容器日志都统一重定向到了 <code>/var/lib/docker/containers/</code> 目录下，这为日志收集提供了很大的便利。</p>
<blockquote>
<p>注意：只有日志驱动为：local、json-file 或者 journald 时，<code>docker logs</code> 命令才能查看到容器打到 stdout/stderr 的日志。</p>
</blockquote>
<p><img src="/images/docker-logging-arch.png" alt=""></p>
<p>下面为官方支持的日志驱动列表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">驱动</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">none</td>
<td style="text-align:left">运行的容器没有日志，<code>docker logs</code> 也不返回任何输出。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/local/" target="_blank" rel="noopener">local</a></td>
<td style="text-align:left">日志以自定义格式存储，旨在实现最小开销。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/json-file/" target="_blank" rel="noopener">json-file</a></td>
<td style="text-align:left">日志格式为JSON。Docker的默认日志记录驱动程序。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/syslog/" target="_blank" rel="noopener">syslog</a></td>
<td style="text-align:left">将日志消息写入syslog。该 syslog 守护程序必须在主机上运行。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/journald/" target="_blank" rel="noopener">journald</a></td>
<td style="text-align:left">将日志消息写入journald。该journald守护程序必须在主机上运行。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/gelf/" target="_blank" rel="noopener">gelf</a></td>
<td style="text-align:left">将日志消息写入Graylog扩展日志格式（GELF）端点，例如Graylog或Logstash。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/fluentd/" target="_blank" rel="noopener">fluentd</a></td>
<td style="text-align:left">将日志消息写入fluentd（转发输入）。该fluentd守护程序必须在主机上运行。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/awslogs/" target="_blank" rel="noopener">awslogs</a></td>
<td style="text-align:left">将日志消息写入Amazon CloudWatch Logs。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/splunk/" target="_blank" rel="noopener">splunk</a></td>
<td style="text-align:left">使 用HTTP 事件收集器将日志消息写入 splunk。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/etwlogs/" target="_blank" rel="noopener">etwlogs</a></td>
<td style="text-align:left">将日志消息写为 Windows 事件跟踪（ETW）事件。仅适用于Windows平台。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/gcplogs/" target="_blank" rel="noopener">gcplogs</a></td>
<td style="text-align:left">将日志消息写入 Google Cloud Platform（GCP）Logging。</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.docker.com/config/containers/logging/logentries/" target="_blank" rel="noopener">logentries</a></td>
<td style="text-align:left">将日志消息写入 Rapid7 Logentries。</td>
</tr>
</tbody>
</table>
<h4 id="Docker-日志驱动（loging-driver）配置"><a href="#Docker-日志驱动（loging-driver）配置" class="headerlink" title="Docker 日志驱动（loging driver）配置"></a>Docker 日志驱动（loging driver）配置</h4><p>上面我们已经知道 Docker 支持多种日志驱动类型，我们可以修改默认的日志驱动配置。日志驱动可以全局配置，也可以给特定容器配置。</p>
<ul>
<li><p>查看 Docker 当前的日志驱动配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker  info |grep  <span class="string">"Logging Driver"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看单个容器的设置的日志驱动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect  -f <span class="string">'&#123;&#123;.HostConfig.LogConfig.Type&#125;&#125;'</span>   容器id</span><br></pre></td></tr></table></figure>
</li>
<li><p>Docker 日志驱动全局配置<br>全局配置意味所有容器都生效，编辑 /etc/docker/daemon.json 文件（如果文件不存在新建一个），添加日志驱动配置。<br>示例：配置 Docker 引擎日志驱动为 <code>syslog</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"log-driver"</span>: <span class="string">"syslog"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给特定容器配置日志驱动<br>在启动容器时指定日志驱动 <code>--log-driver</code> 参数。<br>示例：启动 nginx 容器，日志驱动指定为 journald</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker  run --name nginx -d --<span class="built_in">log</span>-driver journald nginx</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Docker-默认的日志驱动-json-file"><a href="#Docker-默认的日志驱动-json-file" class="headerlink" title="Docker 默认的日志驱动 json-file"></a>Docker 默认的日志驱动 <code>json-file</code></h4><p>json-file 日志驱动记录所有容器的 STOUT/STDERR 的输出 ，用 JSON 的格式写到文件中，每一条 json 日志中默认包含 <code>log</code>, <code>stream</code>, <code>time</code> 三个字段，示例日志如下：<br>文件路径为：<br><code>/var/lib/docker/containers/40f1851f5eb9e684f0b0db216ea19542529e0a2a2e7d4d8e1d69f3591a573c39/40f1851f5eb9e684f0b0db216ea19542529e0a2a2e7d4d8e1d69f3591a573c39-json.log</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"log"</span>:<span class="string">"14:C 25 Jul 2019 12:27:04.072 * DB saved on disk\n"</span>,<span class="string">"stream"</span>:<span class="string">"stdout"</span>,<span class="string">"time"</span>:<span class="string">"2019-07-25T12:27:04.072712524Z"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么打到磁盘的 json 文件该如何配置轮转，防止撑满磁盘呢？每种 Docker 日志驱动都有相应的配置项日志轮转，比如根据单个文件大小和日志文件数量配置轮转。<code>json-file</code> 日志驱动支持的配置选项如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">选项</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">示例值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">max-size</td>
<td style="text-align:left">切割之前日志的最大大小。可取值单位为(k,m,g)， 默认为-1（表示无限制）。</td>
<td style="text-align:left"><code>--log-opt max-size=10m</code></td>
</tr>
<tr>
<td style="text-align:left">max-file</td>
<td style="text-align:left">可以存在的最大日志文件数。如果切割日志会创建超过阈值的文件数，则会删除最旧的文件。仅在max-size设置时有效。正整数。默认为1。</td>
<td style="text-align:left"><code>--log-opt max-file=3</code></td>
</tr>
<tr>
<td style="text-align:left">labels</td>
<td style="text-align:left">适用于启动Docker守护程序时。此守护程序接受的以逗号分隔的与日志记录相关的标签列表。</td>
<td style="text-align:left"><code>--log-opt labels=production_status,geo</code></td>
</tr>
<tr>
<td style="text-align:left">env</td>
<td style="text-align:left">适用于启动Docker守护程序时。此守护程序接受的以逗号分隔的与日志记录相关的环境变量列表。</td>
<td style="text-align:left"><code>--log-opt env=os,customer</code></td>
</tr>
<tr>
<td style="text-align:left">compress</td>
<td style="text-align:left">切割的日志是否进行压缩。默认是disabled。</td>
<td style="text-align:left"><code>--log-opt compress=true</code></td>
</tr>
</tbody>
</table>
<h3 id="Kubernetes-日志管理机制"><a href="#Kubernetes-日志管理机制" class="headerlink" title="Kubernetes 日志管理机制"></a>Kubernetes 日志管理机制</h3><p>在 Kubernetes 中日志也主要有两大类：</p>
<ul>
<li>应用 Pod 日志；</li>
<li>Kuberntes 集群组件日志；</li>
</ul>
<h5 id="应用-Pod-日志"><a href="#应用-Pod-日志" class="headerlink" title="应用 Pod 日志"></a>应用 Pod 日志</h5><p> Kubernetes Pod 的日志管理是基于 Docker 引擎的，Kubernetes 并不管理日志的轮转策略，日志的存储都是基于 Docker 的日志管理策略。k8s 集群调度的基本单位就是 Pod，而 Pod 是一组容器，所以 k8s 日志管理基于 Docker 引擎这一说法也就不难理解了，最终日志还是要落到一个个容器上面。</p>
<p><img src="/images/k8s-logging-arch.png" alt=""></p>
<p>假设 Docker 日志驱动为 <code>json-file</code>，那么在 k8s 每个节点上，kubelet 会为每个容器的日志创建一个软链接，软连接存储路径为：<code>/var/log/containers/</code>，软连接会链接到 <code>/var/log/pods/</code> 目录下相应 pod 目录的容器日志，被链接的日志文件也是软链接，最终链接到 Docker 容器引擎的日志存储目录：<code>/var/lib/docker/container</code> 下相应容器的日志。另外这些软链接文件名称含有 k8s 相关信息，比如：Pod id，名字空间，容器 ID 等信息，这就为日志收集提供了很大的便利。</p>
<p>举例：我们跟踪一个容器日志文件，证明上述的说明，跟踪一个 kong Pod 日志，Pod 副本数为 1</p>
<blockquote>
<p>/var/log/containers/kong-kong-d889cf995-2ntwz_kong_kong-432e47df36d0992a3a8d20ef6912112615ffeb30e6a95c484d15614302f8db03.log<br><code>-------&gt;</code><br>/var/log/pods/kong_kong-kong-d889cf995-2ntwz_a6377053-9ca3-48f9-9f73-49856908b94a/kong/0.log<br><code>-------&gt;</code><br>/var/lib/docker/containers/432e47df36d0992a3a8d20ef6912112615ffeb30e6a95c484d15614302f8db03/432e47df36d0992a3a8d20ef6912112615ffeb30e6a95c484d15614302f8db03-json.log</p>
</blockquote>
<p><img src="/images/docker-k8s-logging-arch.png" alt=""></p>
<h5 id="Kuberntes-集群组件日志"><a href="#Kuberntes-集群组件日志" class="headerlink" title="Kuberntes 集群组件日志"></a>Kuberntes 集群组件日志</h5><p>Kuberntes 集群组件日志分为两类：</p>
<ul>
<li>运行在容器中的 Kubernetes scheduler 和 kube-proxy。</li>
<li>未运行在容器中的 kubelet 和容器 runtime，比如 Docker。</li>
</ul>
<p>在使用 systemd 机制的服务器上，kubelet 和容器 runtime 写入日志到 journald。如果没有 systemd，他们写入日志到 /var/log 目录的 .log 文件。容器中的系统组件通常将日志写到 /var/log 目录，在 kubeadm 安装的集群中它们以静态 Pod 的形式运行在集群中，因此日志一般在 <code>/var/log/pods</code> 目录下。</p>
<h3 id="Kubernetes-集群日志收集方案"><a href="#Kubernetes-集群日志收集方案" class="headerlink" title="Kubernetes 集群日志收集方案"></a>Kubernetes 集群日志收集方案</h3><p> Kubernetes 本身并未提供集群日志收集方案，k8s 官方文档给了三种日志收集的建议方案：</p>
<ul>
<li>使用运行在每个节点上的节点级的日志代理</li>
<li>在应用程序的 pod 中包含专门记录日志 sidecar 容器</li>
<li>应用程序直接将日志传输到日志平台</li>
</ul>
<h4 id="节点级日志代理方案"><a href="#节点级日志代理方案" class="headerlink" title="节点级日志代理方案"></a>节点级日志代理方案</h4><p>从前面的介绍我们已经了解到，k8s 每个节点都将容器日志统一存储到了 <code>/var/log/containers/</code> 目录下，因此可以在每个节点安装一个日志代理，将该目录下的日志实时传输到日志存储平台。</p>
<p>由于需要每个节点运行一个日志代理，因此日志代理推荐以 DaemonSet 的方式运行在每个节点。官方推荐的日志代理是 fluentd，当然也可以使用其他日志代理，比如 filebeat，logstash 等。</p>
<p><img src="/images/k8s-logging-arch1.png" alt=""></p>
<h4 id="sidecar-容器方案"><a href="#sidecar-容器方案" class="headerlink" title="sidecar 容器方案"></a>sidecar 容器方案</h4><p>有两种使用 sidecar 容器的方式：</p>
<ul>
<li>sidecar 容器重定向日志流</li>
<li>sidecar 容器作为日志代理</li>
</ul>
<h5 id="sidecar-容器重定向日志流"><a href="#sidecar-容器重定向日志流" class="headerlink" title="sidecar 容器重定向日志流"></a>sidecar 容器重定向日志流</h5><p>这种方式基于节点级日志代理方案，sidecar 容器和应用容器在同一个 Pod 运行，这个容器的作用就是读取应用容器的日志文件，然后将读取的日志内容重定向到 stdout 和 stderr，然后通过节点级日志代理统一收集。这种方式不推荐使用，缺点就是日志重复存储了，导致磁盘使用会成倍增加。比如应用容器的日志本身打到文件存储了一份，sidecar 容器重定向又存储了一份（存储到了 /var/lib/docker/containers/ 目录下）。这种方式的应用场景是应用本身不支持将日志打到 stdout 和 stderr，所以才需要 sidecar 容器重定向下。</p>
<p><img src="/images/k8s-logging-arch2.png" alt=""></p>
<h5 id="sidecar-容器作为日志代理"><a href="#sidecar-容器作为日志代理" class="headerlink" title="sidecar 容器作为日志代理"></a>sidecar 容器作为日志代理</h5><p>这种方式不需要节点级日志代理，和应用容器在一起的 sidecar 容器直接作为日志代理方式运行在 Pod 中，sidecar 容器读取应用容器的日志，然后直接实时传输到日志存储平台。很显然这种方式也存在一个缺点，就是每个应用 Pod 都需要有个 sidecar 容器作为日志代理，而日志代理对系统 CPU、和内存都有一定的消耗，在节点 Pod 数很多的时候这个资源消耗其实是不小的。另外还有个问题就是在这种方式下由于应用容器日志不直接打到 stdout 和 stderr，所以是无法使用 <code>kubectl logs</code> 命令查看 Pod 中容器日志。</p>
<p><img src="/images/k8s-logging-arch3.png" alt=""></p>
<h4 id="应用程序直接将日志传输到日志平台"><a href="#应用程序直接将日志传输到日志平台" class="headerlink" title="应用程序直接将日志传输到日志平台"></a>应用程序直接将日志传输到日志平台</h4><p>这种方式就是应用程序本身直接将日志打到统一的日志收集平台，比如 Java 应用可以配置日志的 appender，打到不同的地方，很显然这种方式对应用程序有一定的侵入性，而且还要保证日志系统的健壮性，从这个角度看应用和日志系统还有一定的耦合性，所以个人不是很推荐这种方式。</p>
<p>总结：综合对比上述三种日志收集方案优缺点，更推荐使用节点级日志代理方案，这种方式对应用没有侵入性，而且对系统资源没有额外的消耗，也不影响 kubelet 工具查看 Pod 容器日志。</p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://juejin.im/entry/5c03f8bb5188251ba905741d" target="_blank" rel="noopener">https://juejin.im/entry/5c03f8bb5188251ba905741d</a> | Docker 日志驱动配置<br><a href="https://www.cnblogs.com/operationhome/p/10907591.html" target="_blank" rel="noopener">https://www.cnblogs.com/operationhome/p/10907591.html</a> | Docker容器日志管理最佳实践<br><a href="https://www.cnblogs.com/cocowool/p/Docker_Kubernetes_Log_Location.html" target="_blank" rel="noopener">https://www.cnblogs.com/cocowool/p/Docker_Kubernetes_Log_Location.html</a> | 谈一下Docker与Kubernetes集群的日志和日志管理<br><a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/logging/</a> | Kubernetes 日志架构</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/22/Kubernetes-集群安全机制详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/22/Kubernetes-集群安全机制详解/" itemprop="url">Kubernetes 集群安全机制详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-22T12:24:43+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍 Kubernetes 的安全机制，如何使用一系列概念、技术点、机制确保集群的访问是安全的，涉及到的关键词有：api-server，认证，授权，准入控制，RBAC，Service Account，客户端证书认证，Kubernetes 用户，Token 认证等等。虽然涉及到的技术点比较琐碎，比较多，但是了解整个机制后就很容易将其串起来，从而能很好地理解 Kubernetes 集群安全机制。本文结构如下：</p>
<ul>
<li>Kubernetes api-server 安全访问机制；</li>
<li>Kubernetes 认证方式之客户端证书（TLS）；</li>
<li>Kubernetes 授权方式之 RBAC 介绍；</li>
<li>Kubernetes 中两种账号类型介绍；</li>
<li>实践：基于客户端证书认证方式新建 Kubeconfig 访问集群；</li>
<li>实践：Kubeconfig 或 token 方式登陆 Kubernetes dashboard；</li>
</ul>
<h3 id="Kubernetes-api-server-安全访问机制"><a href="#Kubernetes-api-server-安全访问机制" class="headerlink" title="Kubernetes api-server 安全访问机制"></a>Kubernetes api-server 安全访问机制</h3><p>kube-apiserver 是 k8s 整个集群的入口，是一个 REST API 服务，提供的 API 实现了 Kubernetes 各类资源对象（如 Pod，RC，Service 等）的增、删、改、查，API Server 也是集群内各个功能模块之间交互和通信的枢纽，是整个集群的总线和数据中心。<br><img src="/images/k8s-arch1.png" alt=""></p>
<p>由此可见 API Server 的重要性了，我们用 kubectl、各种语言提供的客户端库或者发送 REST 请求和集群交互，其实底层都是以 HTTP REST 请求的方式同 API Server 交互，那么访问的安全机制是如何保证的呢，总不能随便来一个请求都能接受并响应吧。API Server 为此提供了一套特有的、灵活的安全机制，每个请求到达 API Server 后都会经过：认证(Authentication)–&gt;授权(Authorization)–&gt;准入控制(Admission Control) 三道安全关卡，通过这三道安全关卡的请求才给予响应：<br><img src="/images/k8s-secure.png" alt=""></p>
<h4 id="认证-Authentication"><a href="#认证-Authentication" class="headerlink" title="认证(Authentication)"></a>认证(Authentication)</h4><p>认证阶段的工作是识别用户身份，支持的认证方式有很多，比如：HTTP Base，HTTP token，TLS，Service Account，OpenID Connect 等，API Server 启动时可以同时指定多种认证方式，会逐个使用这些方法对客户请求认证，只要通过任意一种认证方式，API Server 就会认为 Authentication 成功。高版本的 Kubernetes 默认认证方式是 TLS。在 TLS 认证方案中，每个用户都拥有自己的 X.509 客户端证书，API 服务器通过配置的证书颁发机构（CA）验证客户端证书。</p>
<h4 id="授权-Authorization"><a href="#授权-Authorization" class="headerlink" title="授权(Authorization)"></a>授权(Authorization)</h4><p>授权阶段判断请求是否有相应的权限，授权方式有多种：AlwaysDeny，AlwaysAllow，ABAC，RBAC，Node 等。API Server 启动时如果多种授权模式同时被启用，Kubernetes 将检查所有模块，如果其中一种通过授权，则请求授权通过。 如果所有的模块全部拒绝，则请求被拒绝(HTTP状态码403)。高版本 Kubernetes 默认开启的授权方式是 RBAC 和 Node。</p>
<h4 id="准入控制-Admission-Control"><a href="#准入控制-Admission-Control" class="headerlink" title="准入控制(Admission Control)"></a>准入控制(Admission Control)</h4><p>准入控制判断操作是否符合集群要求，准入控制配备有一个“准入控制器”的列表，发送给 API Server 的每个请求都需要通过每个准入控制器的检查，检查不通过，则 API Server 拒绝调用请求，有点像 Web 编程的拦截器的意思。具体细节在这里不进行展开了，如想进一步了解见这里：<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" target="_blank" rel="noopener">Using Admission Controllers</a>。</p>
<h3 id="Kubernetes-认证方式之客户端证书（TLS）"><a href="#Kubernetes-认证方式之客户端证书（TLS）" class="headerlink" title="Kubernetes 认证方式之客户端证书（TLS）"></a>Kubernetes 认证方式之客户端证书（TLS）</h3><p>通过上一节介绍我们知道 Kubernetes 认证方式有多种，这里我们简单介绍下客户端证书（TLS）认证方式，也叫 HTTPS 双向认证。一般我们访问一个 https 网站，认证是单向的，只有客户端会验证服务端的身份，服务端不会管客户端身份如何。我们来大概看下 HTTPS 握手过程（单向认证）：</p>
<ol>
<li>客户端发送 Client Hello 消息给服务端；</li>
<li>服务端回复 Server Hello 消息和自身证书给客户端；<br>3.客户端检查服务端证书的合法性，证书检查通过后根据双方发送的消息生成 Premaster Key，然后用服务端的证书里面的公钥加密 Premaster Key 并发送给服务端 ；</li>
<li>服务端通过自己的私钥解密得到 Premaster Key，然后通过双方协商的算法和交换的消息生成 Session Key（后续双方数据加密用的对称密钥，客户端也能通过同样的方法生成同样的 Key），然后回复客户端一个消息表明握手结束，后续发送的消息会以协商的对称密钥加密。</li>
</ol>
<blockquote>
<p>关于 HTTPS 握手详细过程见之前文章：「<a href="https://blog.csdn.net/qianghaohao/article/details/90581126" target="_blank" rel="noopener">Wireshark 抓包理解 HTTPS 协议</a>」</p>
</blockquote>
<p>HTTPS 双向认证的过程就是在上述第 3 步的时候同时回复自己的证书给服务端，然后第 4 步服务端验证收到客户端证书的合法性，从而达到了验证客户端的目的。在 Kubernetes 中就是用了这样的机制，只不过相关的 CA 证书是自签名的：<br><img src="/images/k8s-https.png" alt=""></p>
<h3 id="Kubernetes-授权方式之-RBAC-介绍"><a href="#Kubernetes-授权方式之-RBAC-介绍" class="headerlink" title="Kubernetes 授权方式之 RBAC 介绍"></a>Kubernetes 授权方式之 RBAC 介绍</h3><p>基于角色的访问控制（Role-Based Access Control, 即 RBAC），是 k8s 提供的一种授权策略，也是新版集群默认启用的方式。RBAC 将角色和角色绑定分开，角色指的是一组定义好的操作集群资源的权限，而角色绑定是将角色和用户、组或者服务账号实体绑定，从而赋予这些实体权限。可以看出 RBAC 这种授权方式很灵活，要赋予某个实体权限只需要绑定相应的角色即可。针对 RBAC 机制，k8s 提供了四种 API 资源：Role、ClusterRole、RoleBinding、ClusterRoleBinding。<br><img src="/images/k8s-rbac.png" alt=""></p>
<ul>
<li><p>Role: 只能用于授予对某一单一命名空间中资源的访问权限，因此在定义时必须指定 namespace；<br>以下示例描述了 default 命名空间中的一个 Role 对象的定义，用于授予对 pod 的读访问权限：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span> <span class="comment"># 空字符串""表明使用core API group</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["pods"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ClusterRole：针对集群范围的角色，能访问整个集群的资源；<br>下面示例中的 ClusterRole 定义可用于授予用户对某一特定命名空间，或者所有命名空间中的 secret（取决于其绑定方式）的读访问权限：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 鉴于ClusterRole是集群范围对象，所以这里不需要定义"namespace"字段</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span> <span class="string">["secrets"]</span></span><br><span class="line"><span class="attr">  verbs:</span> <span class="string">["get",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>RoleBinding：将 Role 和用户实体绑定，从而赋予用户实体命名空间内的权限，同时也支持 ClusterRole 和用户实体的绑定；<br>下面示例中定义的 RoleBinding 对象在 default 命名空间中将 pod-reader 角色授予用户 jane。 这一授权将允许用户 jane 从 default 命名空间中读取pod：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下角色绑定定义将允许用户"jane"从"default"命名空间中读取pod。</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">read-pods</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">jane</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ClusterRoleBinding：将 ClusterRole 和用户实体绑定，从而赋予用户实体集群范围的权限；<br>下面示例中所定义的 ClusterRoleBinding 允许在用户组 manager 中的任何用户都可以读取集群中任何命名空间中的 secret：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下`ClusterRoleBinding`对象允许在用户组"manager"中的任何用户都可以读取集群中任何命名空间中的secret。</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">Group</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">manager</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>关于 RBAC 更详细的讲解见这里：<a href="https://jimmysong.io/kubernetes-handbook/concepts/rbac.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/concepts/rbac.html</a></p>
</blockquote>
<h3 id="Kubernetes-中两种账号类型介绍"><a href="#Kubernetes-中两种账号类型介绍" class="headerlink" title="Kubernetes 中两种账号类型介绍"></a>Kubernetes 中两种账号类型介绍</h3><p>K8S中有两种用户(User)：服务账号(ServiceAccount)和普通的用户(User)。 ServiceAccount 是由 k8s 管理的，而 User 账号是在外部管理，k8s 不存储用户列表，也就是说针对用户的增、删、该、查都是在集群外部进行，k8s 本身不提供普通用户的管理。</p>
<p>两种账号的区别：</p>
<ul>
<li>ServiceAccount 是 k8s 内部资源，而普通用户是存在于 k8s 之外的；</li>
<li>ServiceAccount 是属于某个命名空间的，不是全局的，而普通用户是全局的，不归某个 namespace 特有；</li>
<li>ServiceAccount 一般用于集群内部 Pod 进程使用，和 api-server 交互，而普通用户一般用于 kubectl 或者 REST 请求使用；</li>
</ul>
<h4 id="ServiceAccount-的实际应用"><a href="#ServiceAccount-的实际应用" class="headerlink" title="ServiceAccount 的实际应用"></a>ServiceAccount 的实际应用</h4><p>ServiceAccount 可以用于 Pod 访问 api-server，其对应的 Token 可以用于 kubectl 访问集群，或者登陆 kubernetes dashboard。</p>
<h4 id="普通用户的实际应用"><a href="#普通用户的实际应用" class="headerlink" title="普通用户的实际应用"></a>普通用户的实际应用</h4><ul>
<li>X509 客户端证书<br>客户端证书验证通过为API Server 指定 –client-ca-file=xxx 选项启用，API Server通过此 ca 文件来验证 API 请求携带的客户端证书的有效性，一旦验证成功，API Server 就会将客户端证书 Subject 里的 CN 属性作为此次请求的用户名。关于客户端证书方式的用户后面会有专门的实践介绍。</li>
<li>静态token文件<br>通过指定–token-auth-file=SOMEFILE 选项来启用 bearer token 验证方式，引用的文件是一个包含了 <code>token,用户名,用户ID</code> 的csv文件，请求时，带上 <code>Authorization: Bearer xxx</code> 头信息即可通过 bearer token 验证；</li>
<li>静态密码文件<br>通过指定 <code>--basic-auth-file=SOMEFILE</code> 选项启用密码验证，引用的文件是一个包含 <code>密码,用户名,用户ID</code> 的csv文件，请求时需要将 <code>Authorization</code> 头设置为 <code>Basic BASE64ENCODED(USER:PASSWORD)</code>；</li>
</ul>
<h3 id="实践：基于客户端证书认证方式新建-Kubeconfig-访问集群"><a href="#实践：基于客户端证书认证方式新建-Kubeconfig-访问集群" class="headerlink" title="实践：基于客户端证书认证方式新建 Kubeconfig 访问集群"></a>实践：基于客户端证书认证方式新建 Kubeconfig 访问集群</h3><h4 id="Kubeconfig-文件详解"><a href="#Kubeconfig-文件详解" class="headerlink" title="Kubeconfig 文件详解"></a>Kubeconfig 文件详解</h4><p>我们知道在安装完 k8s 集群后会生成 $HOME/.kube/config 文件，这个文件就是 kubectl 命令行工具访问集群时使用的认证文件，也叫 Kubeconfig 文件。这个 Kubeconfig 文件中有很多重要的信息，文件大概结构是这样，这里说明下每个字段的含义：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">- cluster:</span></span><br><span class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr">https://192.168.26.10:6443</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="attr">- context:</span></span><br><span class="line"><span class="attr">    cluster:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">kubernetes-admin</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    client-certificate-data:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">    client-key-data:</span> <span class="string">...</span></span><br></pre></td></tr></table></figure></p>
<p>可以看出文件分为三大部分：clusters、contexts、users<br><strong>clusters 部分</strong><br>定义集群信息，包括 api-server 地址、certificate-authority-data: 用于服务端证书认证的自签名 CA 根证书（master 节点 /etc/kubernetes/pki/ca.crt 文件内容 ）。</p>
<p><strong>contexts 部分</strong><br>集群信息和用户的绑定，kubectl 通过上下文提供的信息连接集群。</p>
<p><strong>users 部分</strong><br>多种用户类型，默认是客户端证书（x.509 标准的证书）和证书私钥，也可以是 ServiceAccount Token。这里重点说下前者：</p>
<ul>
<li><code>client-certificate-data</code>: base64 加密后的客户端证书；</li>
<li><code>client-key-data</code>: base64 加密后的证书私钥；</li>
</ul>
<p>一个请求在通过 api-server 的认证关卡后，api-server 会从收到客户端证书中取用户信息，然后用于后面的授权关卡，这里所说的用户并不是服务账号，而是客户端证书里面的 Subject 信息：O 代表用户组，CN 代表用户名。为了证明，可以使用 openssl 手动获取证书中的这个信息：<br>首先，将 Kubeconfig 证书的 user 部分 <code>client-certificate-data</code> 字段内容进行 base64 解密，保存文件为 client.crt，然后使用 openssl 解析证书信息即可看到 Subject 信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> client.crt -text</span><br></pre></td></tr></table></figure></p>
<p>解析集群默认的 Kubeconfig 客户端证书得到的 Subject 信息是：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Subject: <span class="attribute">O</span>=system:masters, <span class="attribute">CN</span>=kubernetes-admin</span><br></pre></td></tr></table></figure></p>
<p>可以看出该证书绑定的用户组是 <code>system:masters</code>，用户名是 <code>kubernetes-admin</code>，而集群中默认有个 ClusterRoleBinding 叫 cluster-admin，它将名为 cluster-admin 的 ClusterRole 和用户组 <code>system:masters</code> 进行了绑定，而名为 cluster-admin 的 ClusterRole 有集群范围的 Superadmin 权限，这也就理解了为什么默认的 Kubeconfig 能拥有极高的权限来操作 k8s 集群了。</p>
<h4 id="新建具有只读权限的-Kubeconfig-文件"><a href="#新建具有只读权限的-Kubeconfig-文件" class="headerlink" title="新建具有只读权限的 Kubeconfig 文件"></a>新建具有只读权限的 Kubeconfig 文件</h4><p>上面我们已经解释了为什么默认的 Kubeconfig 文件具有 Superadmin 权限，这个权限比较高，有点类型 Linux 系统的 Root 权限。有时我们会将集群访问权限开放给其他人员，比如供研发人员查看 Pod 状态、日志等信息，这个时候直接用系统默认的 Kubeconfig 就不太合理了，权限太大，集群的安全性没有了保障。更合理的做法是给研发人员一个只读权限的账号，避免对集群进行一些误操作导致故障。</p>
<p>我们以客户端证书认证方式创建 Kubeconfig 文件，所以需要向集群自签名 CA 机构（master 节点）申请证书，然后通过 RBAC 授权方式给证书用户授予集群只读权限，具体方法如下：</p>
<blockquote>
<p>假设我们设置证书的用户名为：developer – 证书申请时 -subj 选项 CN 参数。</p>
</blockquote>
<h5 id="生成客户端-TLS-证书"><a href="#生成客户端-TLS-证书" class="headerlink" title="生成客户端 TLS 证书"></a>生成客户端 TLS 证书</h5><ol>
<li><p>创建证书私钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out developer.key 2048</span><br></pre></td></tr></table></figure>
</li>
<li><p>用上面私钥创建一个 csr(证书签名请求)文件，其中我们需要在 subject 里带上用户信息(CN为用户名，O为用户组)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key developer.key -out developer.csr -subj <span class="string">"/CN=developer"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>其中/O参数可以出现多次，即可以有多个用户组</p>
</blockquote>
</li>
<li><p>找到 k8s 集群(API Server)的 CA 根证书文件，其位置取决于安装集群的方式，通常会在 master 节点的 /etc/kubernetes/pki/ 路径下，会有两个文件，一个是 CA 根证书(ca.crt)，一个是 CA 私钥(ca.key) 。</p>
</li>
<li>通过集群的 CA 根证书和第 2 步创建的 csr 文件，来为用户颁发证书<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> developer.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out developer.crt -days 365</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>至此，客户端证书颁发完成，我们后面会用到文件是 developer.key 和 developer.crt</p>
</blockquote>
<h5 id="基于-RBAC-授权方式授予用户只读权限"><a href="#基于-RBAC-授权方式授予用户只读权限" class="headerlink" title="基于 RBAC 授权方式授予用户只读权限"></a>基于 RBAC 授权方式授予用户只读权限</h5><p>在 k8s 集群中已经有个默认的名为 <code>view</code> 只读 ClusterRole 了，我们只需要将该 ClusterRole 绑定到 developer 用户即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubernetes-viewer --clusterrole=view --user=developer</span><br></pre></td></tr></table></figure></p>
<h5 id="基于客户端证书生成-Kubeconfig-文件"><a href="#基于客户端证书生成-Kubeconfig-文件" class="headerlink" title="基于客户端证书生成 Kubeconfig 文件"></a>基于客户端证书生成 Kubeconfig 文件</h5><p>前面已经生成了客户端证书，并给证书里的用户赋予了集群只读权限，接下来基于客户端证书生成 Kubeconfig 文件：<br>拷贝一份 $HOME/.kube.config，假设名为 developer-config，在其基础上做修改：</p>
<ol>
<li>contexts 部分 user 字段改为 developer，name 字段改为 developer@kubernetes。（这些改动随意命名，只要前后统一即可）；</li>
<li><p>users 部分 name 字段改为 developer，client-certificate-data 字段改为 developer.crt base64 加密后的内容，client-key-data 改为 developer.key base64 加密后的内容；</p>
<blockquote>
<p>注意：证书 base64 加密时指定 –wrap=0 参数<br>cat developer.crt | base64 –wrap=0<br>cat developer.key | base64 –wrap=0</p>
</blockquote>
<p> 接下来测试使用新建的 Kubeconfig 文件:</p>
<blockquote>
<p>[root@master ~]# kubectl –kubeconfig developer-config –context=developer@kubernetes get pod<br>NAME                                READY   STATUS    RESTARTS   AGE<br>nginx-deployment-5754944d6c-dqsdj   1/1     Running   0          5d9h<br>nginx-deployment-5754944d6c-q675s   1/1     Running   0          5d9h<br>[root@master ~]# kubectl –kubeconfig developer-config –context=developer@kubernetes delete pod nginx-deployment-5754944d6c-dqsdj<br>Error from server (Forbidden): pods “nginx-deployment-5754944d6c-dqsdj” is forbidden: User “developer” cannot delete resource “pods” in API group “” in the namespace “default”</p>
</blockquote>
</li>
</ol>
<p>可以看出新建的 Kubeconfig 文件可以使用，写权限是被 forbidden 的，说明前面配的 RBAC 权限机制是起作用的。</p>
<h3 id="实践：Kubeconfig-或-token-方式登陆-Kubernetes-dashboard"><a href="#实践：Kubeconfig-或-token-方式登陆-Kubernetes-dashboard" class="headerlink" title="实践：Kubeconfig 或 token 方式登陆 Kubernetes dashboard"></a>实践：Kubeconfig 或 token 方式登陆 Kubernetes dashboard</h3><p>我们打开 kubernetes dashboard 访问地址首先看到的是登陆认证页面，有两种登陆认证方式可供选择：Kubeconfig 和 Token 方式<br><img src="/images/k8s-dashboard-login.png" alt=""></p>
<p>其实两种方式都需要服务账号的 Token，对于 Kubeconfig 方式直接使用集群默认的 Kubeconfig: $HOME/.kube/config 文件不能登陆，因为文件中缺少 Token 字段，所以直接选择本地的 Kubeconfig 文件登陆会报错。正确的使用方法是获取某个服务账号的 Token，然后将 Token 加入到 $HOME/.kube/config 文件。下面具体实践下两种登陆 dashboard 方式：</p>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>首先，两种方式都需要服务账号，所以我们先创建一个服务账号，然后为了测试，给这个服务账号一个查看权限（RBAC 授权），到时候登陆 dashboard 后只能查看，不能对集群中的资源做修改。</p>
<ol>
<li><p>创建一个服务账号（在 default 命名空间下）；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount kube-dashboard-reader</span><br></pre></td></tr></table></figure>
</li>
<li><p>将系统自带的 ClusterRole：view 角色绑定到上一步创建的服务账号，授予集群范围的资源只读权限；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kube-dashboard-reader --clusterrole=view --serviceaccount=default:kube-dashboard-reader</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取服务账号的 token；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret `kubectl get secret -n default | grep kube-dashboard-reader | awk <span class="string">'&#123;print $1&#125;'</span>` -o jsonpath=&#123;.data.token&#125; -n default | base64 -d</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Kubeconfig-方式登陆-dashboard"><a href="#Kubeconfig-方式登陆-dashboard" class="headerlink" title="Kubeconfig 方式登陆 dashboard"></a>Kubeconfig 方式登陆 dashboard</h4><p>拷贝一份 $HOME/.kube/config，修改内容，将准备工作中获取的 Token 添加入到文件中：在 Kubeconfig 的 Users 下 User 部分添加，类型下面这样:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">kubernetes-admin</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    client-certificate-data:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">    client-key-data:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">    token:</span> <span class="string">&lt;这里为上面获取的</span> <span class="string">Token...&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后登陆界面选择 Kubeconfig 单选框，选择该文件即可成功登陆 dashboard。</p>
<h4 id="Token-方式登陆-dashboard"><a href="#Token-方式登陆-dashboard" class="headerlink" title="Token 方式登陆 dashboard"></a>Token 方式登陆 dashboard</h4><p>登陆界面选择 Token 单选框，将准备工作中获取的 Token 粘贴进去即可成功登陆。</p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/controlling-access/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/reference/access-authn-authz/controlling-access/</a> | Kubernetes API 访问控制<br><a href="https://mp.weixin.qq.com/s/u4bGemn1cxbiZBoMX54sPA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/u4bGemn1cxbiZBoMX54sPA</a> | 小白都能看懂的 Kubernetes安全之 API-server 安全<br><a href="https://zhuanlan.zhihu.com/p/43237959" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/43237959</a> | 为 Kubernetes 集群添加用户<br><a href="https://tonybai.com/2016/11/25/the-security-settings-for-kubernetes-cluster/" target="_blank" rel="noopener">https://tonybai.com/2016/11/25/the-security-settings-for-kubernetes-cluster/</a> | Kubernetes 集群的安全配置<br><a href="https://support.qacafe.com/knowledge-base/how-do-i-display-the-contents-of-a-ssl-certificate/" target="_blank" rel="noopener">https://support.qacafe.com/knowledge-base/how-do-i-display-the-contents-of-a-ssl-certificate/</a> | x.509 证书内容查看</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/17/Kong-微服务网关在-Kubernetes-的实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/17/Kong-微服务网关在-Kubernetes-的实践/" itemprop="url">Kong 微服务网关在 Kubernetes 的实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-17T11:44:28+08:00">
                2019-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/微服务网关/" itemprop="url" rel="index">
                    <span itemprop="name">微服务网关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍将 <a href="https://konghq.com/kong/" target="_blank" rel="noopener">Kong</a> 微服务网关作为 Kubernetes 集群统一入口的最佳实践，之前写过一篇文章使用 <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Nginx Ingress Controller</a> 作为集群统一的流量入口：<a href="https://qhh.me/2019/08/12/%E4%BD%BF%E7%94%A8-Kubernetes-Ingress-%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1/" target="_blank" rel="noopener">使用 Kubernetes Ingress 对外暴露服务</a>，但是相比于 <a href="https://github.com/Kong/kubernetes-ingress-controller" target="_blank" rel="noopener">Kong Ingress Controller</a> 来说，Kong 支持的功能更加强大，更适合微服务架构：</p>
<ul>
<li>拥有庞大的插件生态，能轻易扩展 Kong 支持的功能，比如 API 认证，流控，访问限制等；</li>
<li>Kong 服务本身和 Admin 管理 API 都集成在一个进程，通过端口区分两者，简化了部署的复杂度；</li>
<li>Kong 节点的配置统一持久化到数据库，所有节点通过数据库共享数据，在 Ingress 更新后能实时同步到各个节点，而 Nginx Ingress Controller 是通过重新加载机制响应 Ingress 更新，这种方式代价比较大，可能会导致服务的短暂中断；</li>
<li>Kong 有成熟的第三方管理 UI 和 Admin 管理 API 对接，从而能可视化管理 Kong 配置；</li>
</ul>
<p>本文先介绍 Kong 微服务网关在 Kubernetes 的架构，然后进行架构实践，涉及到的话题有：</p>
<ul>
<li>Kong 微服务网关在 Kubernetes 的架构；</li>
<li>helm 部署 Kong（包含 Kong Ingress Controller）；</li>
<li>部署 Konga；</li>
<li>示例：通过 Konga 配置对外访问 Kubernetes Dashboard；</li>
</ul>
<h3 id="Kong-微服务网关在-Kubernetes-的架构"><a href="#Kong-微服务网关在-Kubernetes-的架构" class="headerlink" title="Kong 微服务网关在 Kubernetes 的架构"></a>Kong 微服务网关在 Kubernetes 的架构</h3><p>Kubernetes 简化了微服务架构，以 Service 为单位，代表一个个微服务，但是 k8s 集群整个网络对外是隔离的，在微服务架构下一般需要一个网关作为所有 API 的入口，在 k8s 中架构微服务同样也需要一个网关，作为集群统一的入口，作为服务消费方和提供方的交互中间件。Kong 可以充当这一网关角色，为集群提供统一的外部流量入口，集群内部 Service 之间通信通过 Service 名称调用：<br><img src="/images/kong-k8s1.png" alt=""><br>那么 Kong 是如何在 k8s 集群上跑起来？具体机制是什么样的？<br>Kong 作为服务接入层，不仅提供了外部流量的接收转发，而且其本身还提供了 Admin 管理 API，通过 Admin 管理 API 实现 Kong 的路由转发等相关配置，这两项功能都是在一个进程中实现。</p>
<p>在 k8s 中 Kong 以 Pod 形式作为节点运行，Pod 通过 Deployment 或者 DaemenSet 管理。所有 Kong 节点共享一个数据库，因此通过 Admin API 配置，所有节点都能同步感知到变化。既然 Kong 以 Pod 的形式运行在 k8s 集群中，那么其本身需要对外暴露，这样外部流量才能进来，在本地可以 nodePort 或者 hostNetwork 对外提供服务，在云平台一般通过 LoadBalancer 实现。一般的部署最佳实践是将 Kong 的 Admin 管理功能独立出来一个 Pod，专门作为所有其他节点的统一配置管理，不对外提供流量转发服务，只提供配置功能，而其他 Kong 节点专门提供流量转发功能。</p>
<p>说一说 Kong Ingress Controller：其实没有 Kong Ingress Controller 也完全够用，其存在的意义是为了实现 k8s Ingress 资源对象。我们知道 Ingress 只不过是定义了一些流量路由规则，但是光有这个路由规则没用，需要 Ingress Controller 来将这些路由规则转化成相应代理的实际配置，比如 Kong Ingress Controller 就可以将 Ingress 转化成 Kong 的配置。与 Nginx Ingress Controller 不同，Kong Ingress Controller 不对外提供服务，只作为 k8s Ingress 资源的解析转化服务，将解析转化的结果（Kong 的配置：比如 Service、Route 实体等）通过与 Kong Admin API 写入 Kong 数据库，所以 Kong Ingress Controller 需要和 Kong Admin API 打通。所以当我们需要配置 Kong 的路由时，既可以通过创建 k8s Ingress 实现，也可以通过 Kong Admin API 直接配置。</p>
<p><img src="/images/kong-k8s2.png" alt=""></p>
<h3 id="helm-部署-Kong（包含-Kong-Ingress-Controller）"><a href="#helm-部署-Kong（包含-Kong-Ingress-Controller）" class="headerlink" title="helm 部署 Kong（包含 Kong Ingress Controller）"></a>helm 部署 Kong（包含 Kong Ingress Controller）</h3><p>说明：本地集群部署，为了方便 Kong Proxy 和 Kong Admin 没有独立开，共用一个进程，同时提供流量转发和 Admin 管理 API。<br>使用 helm 官方 Chart: <a href="https://github.com/helm/charts/tree/master/stable/kong" target="_blank" rel="noopener">stable/kong</a>，由于我是在本地裸机集群部署，很多云的功能不支持，比如：LoadBalancer、PV、PVC 等，所以需要对 Chart 的 values 文件做一些定制化以符合本地需求：</p>
<ul>
<li><p>由于本地裸机集群不支持 LoadBalancer，所以采用 nodePort 方式对外暴露 Kong proxy 和 Kong admin 服务，Chart 默认是 nodePort 方式，在这里自定义下端口：Kong proxy 指定 nodePort 80 和 443 端口，Kong Admin 指定 8001 端口：<code>Values.proxy.http.nodePort: 80</code>  <code>Values.proxy.tls.nodePort: 443</code>, <code>Values.admin.nodePort: 8001</code>；</p>
<blockquote>
<p>注意：默认 k8s nodePort 端口范围是 30000~32767，手动分配该范围之外的端口会报错！该限制可以调整，具体见之前文章：<a href="https://qhh.me/2019/08/15/Kubernetes-%E8%B0%83%E6%95%B4-nodePort-%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4/" target="_blank" rel="noopener">Kubernetes 调整 nodePort 端口范围</a></p>
</blockquote>
</li>
<li><p>启用 Kong admin 和 Kong proxy  Ingress，部署时会创建相应的 Ingress 资源，实现服务对外访问：<code>Values.admin.ingress.enabled: true</code>, <code>Values.proxy.ingress.enabled: true</code>，另外还得设置对外访问的域名（没有域名的话可以随便起个域名，然后绑 /etc/hosts 访问）：<code>Values.admin.ingress.hosts: [admin.kong.com]</code>,  <code>Values.proxy.ingress.hosts: [proxy.kong.com]</code>；</p>
</li>
<li><p>作为练习，为了方便，Kong admin 改用监听 HTTP 8001 端口：<code>Values.admin.useTLS: false</code>, <code>.Values.admin.servicePort: 8001</code>, <code>.Values.admin.containerPort: 8001</code>。另外也需要将 Pod 探针协议也改为 HTTP：<code>Values.livenessProbe.httpGet.scheme: HTTP</code>, <code>Values.readinessProbe.httpGet.scheme: HTTP</code>；</p>
</li>
<li><p>Kong proxy Ingress 启用 HTTPS，这样后续 kong 就可以同时支持 HTTP 和 HTTP 代理了，这里展开下具体过程：</p>
<ol>
<li><p>创建 TLS 证书：域名为 proxy.kong.com</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 65536 -newkey rsa:2048 -keyout proxy-kong.key -out proxy-kong.crt -subj <span class="string">"/CN=proxy.kong.com/O=proxy.kong.com"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用生成的证书创建 k8s Secret 资源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls proxy-kong-ssl --key proxy-kong.key --cert proxy-kong.crt -n kong</span><br></pre></td></tr></table></figure>
<p>编辑 values 文件启用 Kong Proxy Ingress tls，引用上面创建的 Secret：<code>Values.proxy.ingress.tls</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">proxy.kong.com</span></span><br><span class="line"><span class="attr">      secretName:</span> <span class="string">proxy-kong-ssl</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>启用 Kong Ingress Controller，默认是不会部署 Kong Ingress Controller：ingressController.enabled: true；</p>
</li>
<li><p>由于本地裸机环境不支持 PV 存储，所以在部署时禁用 Postgres 数据持久化：helm 安装时指定 <code>--set postgresql.persistence.enabled=false</code>，这样 Postgres 存储会使用 emptyDir 方式挂载卷，在 Pod 重启后数据会丢失，本地自己玩的话可以先这么搞。当然要复杂点的话，可以自己再搭个 nfs 支持 PV 资源对象。</p>
</li>
</ul>
<p>定制后的 values 文件在这里：<a href="https://raw.githubusercontent.com/qhh0205/helm-charts/master/kong-values.yml" target="_blank" rel="noopener">https://raw.githubusercontent.com/qhh0205/helm-charts/master/kong-values.yml</a></p>
<p>helm 部署<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install stable/kong --name kong --<span class="built_in">set</span> postgresql.persistence.enabled=<span class="literal">false</span> -f https://raw.githubusercontent.com/qhh0205/helm-charts/master/kong-values.yml --namespace kong</span><br></pre></td></tr></table></figure></p>
<p>验证部署<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master kong]<span class="comment"># kubectl get pod -n kong                          </span></span><br><span class="line">NAME                                   READY   STATUS      RESTARTS   AGE</span><br><span class="line">kong-kong-controller-76d657b78-r6cj7   2/2     Running     1          58s</span><br><span class="line">kong-kong-d889cf995-dw7kj              1/1     Running     0          58s</span><br><span class="line">kong-kong-init-migrations-c6fml        0/1     Completed   0          58s</span><br><span class="line">kong-postgresql-0                      1/1     Running     0          58s</span><br><span class="line"></span><br><span class="line">[root@master kong]<span class="comment"># kubectl get ingress -n kong</span></span><br><span class="line">NAME              HOSTS            ADDRESS   PORTS     AGE</span><br><span class="line">kong-kong-admin   admin.kong.com             80        84s</span><br><span class="line">kong-kong-proxy   prox.kong.com              80, 443   84s</span><br></pre></td></tr></table></figure></p>
<p>curl 测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master kong]<span class="comment"># curl -I http://admin.kong.com       </span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@master kong]<span class="comment"># curl http://proxy.kong.com</span></span><br><span class="line">&#123;<span class="string">"message"</span>:<span class="string">"no Route matched with those values"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="部署-Konga"><a href="#部署-Konga" class="headerlink" title="部署 Konga"></a>部署 Konga</h3><p>上面已经将整个 Kong 平台运行在了 Kubernetes 集群，并启用了 Kong Ingress Controller，但是目前做 Kong 相关的路由配置只能通过 curl 调 Kong Admin API，配置起来不是很方便。所以需要将针对 Kong 的 UI 管理服务 Konga 部署到集群，并和 Kong 打通，这样就可以可视化做 Kong 的配置了。由于 Konga 的部署很简单，官方也没有 Chart，所以我们通过 yaml 文件创建相关资源。</p>
<p>为了节省资源，Konga 和 Kong 共用一个 Postgresql，Konga 和 Kong 本身对数据库资源占用很少，所以两个同类服务共用一个数据库是完全合理的。下面为 k8s 资源文件，服务对外暴露方式为 Kong Ingress，域名设为(名字随便起的，绑 host 访问)：konga.kong.com：</p>
<blockquote>
<p>数据库密码在前面安装 Kong 时 Chart 创建的 Secret 中，获取方法：<br><code>kubectl get secret kong-postgresql -n kong -o yaml | grep password | awk -F &#39;:&#39; &#39;{print $2}&#39; | tr -d &#39; &#39; | base64 -d</code></p>
</blockquote>
<p>konga.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_ADAPTER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_URI</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"postgresql://kong:K9IV9pHTdS@kong-postgresql:5432/konga_database"</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">pantsel/konga</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">1337</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">1337</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">1337</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">konga</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">konga-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">konga.kong.com</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">konga</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">1337</span></span><br></pre></td></tr></table></figure></p>
<p>kubectl 部署 Konga<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f konga.yml -n kong</span><br></pre></td></tr></table></figure></p>
<p>部署完成后绑定 host 将 konga.kong.com 指向集群节点 IP 即可访问：</p>
<p><img src="/images/kong-k8s3.png" alt=""></p>
<p>接下来随便注册个账号，然后配置连接到 Kong Admin 地址，由于都在集群内部，所以直接用 Kong Admin 的 ServiceName + 端口号连就可以：</p>
<p><img src="/images/kong-k8s4.png" alt=""><br>连接没问题后，主页面会显示 Kong 相关的全局信息：</p>
<p><img src="/images/kong-k8s5.png" alt=""></p>
<h3 id="示例：通过-Konga-配置对外访问-Kubernetes-Dashboard"><a href="#示例：通过-Konga-配置对外访问-Kubernetes-Dashboard" class="headerlink" title="示例：通过 Konga 配置对外访问 Kubernetes Dashboard"></a>示例：通过 Konga 配置对外访问 Kubernetes Dashboard</h3><p>之前我们基于 Nginx Ingress Controller 对外暴露 Kubernetes Dashboard，现在我们基于集群中 Kong 平台配置对外访问，通过 Konga 可视化操作。<br>通过 Konga 配置服务对外访问只需要两步：</p>
<ol>
<li>创建一个对应服务的 Service（不是 k8s 的 Servide，是 Kong 里面 Service 的概念：反向代理上游服务的抽象）；</li>
<li>创建对应 Service 的路由；</li>
</ol>
<p>下面以配置 Kubernetes dashboard 服务对外访问为例，对外域名设为 dashboard.kube.com (名字随便起的，绑 host 访问)</p>
<ol>
<li><p>创建 Kong Service：</p>
<p> <img src="/images/kong-k8s6.png" alt=""></p>
</li>
<li><p>创建服务路由：</p>
<p> <img src="/images/kong-k8s7.png" alt=""><br> <img src="/images/kong-k8s8.png" alt=""><br> <img src="/images/kong-k8s9.png" alt=""></p>
</li>
</ol>
<p>配置完成，浏览器测试访问：<a href="https://dashboard.kube.com" target="_blank" rel="noopener">https://dashboard.kube.com</a></p>
<p><img src="/images/kong-k8s-kube-dashboard.png" alt=""></p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://konghq.com/solutions/kubernetes-ingress/" target="_blank" rel="noopener">https://konghq.com/solutions/kubernetes-ingress/</a> | Kong on Kubernetes<br><a href="https://konghq.com/blog/kubernetes-ingress-controller-for-kong/" target="_blank" rel="noopener">https://konghq.com/blog/kubernetes-ingress-controller-for-kong/</a> | Announcing the Kubernetes Ingress Controller for Kong<br><a href="https://docs.konghq.com/install/kubernetes/" target="_blank" rel="noopener">https://docs.konghq.com/install/kubernetes/</a> | Kong and Kong Enterprise on Kubernetes<br><a href="https://github.com/Kong/kubernetes-ingress-controller" target="_blank" rel="noopener">https://github.com/Kong/kubernetes-ingress-controller</a> | GitHub Kong Ingress Controller</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/15/Kubernetes-调整-nodePort-端口范围/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/15/Kubernetes-调整-nodePort-端口范围/" itemprop="url">Kubernetes 调整 nodePort 端口范围</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-15T21:16:13+08:00">
                2019-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>默认情况下，k8s 集群 nodePort 分配的端口范围为：30000-32767，如果我们指定的端口不在这个范围就会报类似下面这样的错误：</p>
<blockquote>
<p>Error: release kong failed: Service “kong-kong-admin” is invalid: spec.ports[0].nodePort: Invalid value: 8444: provided port is not in the valid range. The range of valid ports is 30000-32767</p>
</blockquote>
<p>解决方法就是调整 kube-apiserver 组件启动参数，指定 nodePort 范围。如果是用 kubeadm 安装的集群，那么 apiserver 是以静态 pod 的形式运行，pod 文件定义在 /etc/kubernetes/manifests/kube-apiserver.yaml。/etc/kubernetes/manifests 目录下是所有静态 pod 文件的定义，kubelet 会监控该目录下文件的变动，只要发生变化，pod 就会重建，响应相应的改动。所以我们修改 /etc/kubernetes/manifests/kube-apiserver.yaml 文件，添加 nodePort 范围参数后会自动生效，无需进行其他操作：<br>vim /etc/kubernetes/manifests/kube-apiserver.yaml<br>在 command 下添加 <code>--service-node-port-range=1-65535</code> 参数，修改后会自动生效，无需其他操作:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    component:</span> <span class="string">kube-apiserver</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">control-plane</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kube-apiserver</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - command:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">kube-apiserver</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--service-node-port-range=1-65535</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--advertise-address=192.168.26.10</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--allow-privileged=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--authorization-mode=Node,RBAC</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--enable-admission-plugins=NodeRestriction</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--enable-bootstrap-token-auth=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--etcd-servers=https://127.0.0.1:2379</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--insecure-port=0</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--requestheader-allowed-names=front-proxy-client</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--requestheader-extra-headers-prefix=X-Remote-Extra-</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--requestheader-group-headers=X-Remote-Group</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--requestheader-username-headers=X-Remote-User</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--secure-port=6443</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--service-account-key-file=/etc/kubernetes/pki/sa.pub</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--service-cluster-ip-range=10.96.0.0/12</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">registry.aliyuncs.com/google_containers/kube-apiserver:v1.15.2</span></span><br><span class="line"><span class="attr">    imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">    livenessProbe:</span></span><br><span class="line"><span class="attr">      failureThreshold:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">      httpGet:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="number">192.168</span><span class="number">.26</span><span class="number">.10</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/healthz</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">        scheme:</span> <span class="string">HTTPS</span></span><br><span class="line"><span class="attr">      initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">      timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">kube-apiserver</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">    volumeMounts:</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">ca-certs</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/etc/pki</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">etc-pki</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - mountPath:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">k8s-certs</span></span><br><span class="line"><span class="attr">      readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">  - hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/etc/ssl/certs</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">ca-certs</span></span><br><span class="line"><span class="attr">  - hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/etc/pki</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">etc-pki</span></span><br><span class="line"><span class="attr">  - hostPath:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">k8s-certs</span></span><br><span class="line"><span class="attr">status:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>相关文档：<br><a href="http://www.thinkcode.se/blog/2019/02/20/kubernetes-service-node-port-range" target="_blank" rel="noopener">http://www.thinkcode.se/blog/2019/02/20/kubernetes-service-node-port-range</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/14/基于-docker-compose-容器化构建-Kong-微服务网关平台/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haohao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jim">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/14/基于-docker-compose-容器化构建-Kong-微服务网关平台/" itemprop="url">基于 docker-compose 容器化构建 Kong 微服务网关平台</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-14T20:05:23+08:00">
                2019-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/微服务网关/" itemprop="url" rel="index">
                    <span itemprop="name">微服务网关</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍如何使用 docker-compose 快速体验 Kong 微服务网关，先简单介绍基本概念，然后做了一个 Demo 测试使用，涉及到的相关话题有：</p>
<ul>
<li>Kong 简介；</li>
<li>Konga 简介；</li>
<li>基于 docker-compose 容器化构建 Kong 微服务网关平台；</li>
<li>使用 Konga 可视化创建一个 Service 及路由；</li>
</ul>
<h3 id="Kong-简介"><a href="#Kong-简介" class="headerlink" title="Kong 简介"></a>Kong 简介</h3><p><a href="https://konghq.com/kong/" target="_blank" rel="noopener">Kong</a> 是微服务网关模式架构中连接服务消费方和服务提供方的中间件系统，即我们经常所说的微服务网关，网关将各自的业务系统的演进和发展做了天然的隔离，使业务系统更加专注于业务服务本身，同时微服务网关还可以为服务提供和沉淀更多附加功能。微服务网关的主要作用如下：</p>
<ul>
<li>请求接入：管理所有请求接入，作为所有 API 接口的请求入口；</li>
<li>业务聚合：所有微服务后端可以注册在 API 网关，通过 API 网关统一暴露服务；</li>
<li>拦截策略：可以通过统一的安全、路由、流控等公共服务组件；</li>
<li>统一管理：提供统一的监控工具，配置管理工具等基础设施；</li>
</ul>
<p>Kong 作为完全开源的微服务网关，基于 Nginx 实现，所以其性能表现是毋庸置疑的，另外和其他网关系统类似，也支持插件化扩展，提供了丰富的插件可供使用。Kong 进程启动后会启动多个端口，每个端口功能也不一样：</p>
<ul>
<li>8001 端口：http 管理 API；</li>
<li>8444 端口：https 管理 API；</li>
<li>8000 端口：接收处理 http 流量；</li>
<li>8443 端口：接收处理 https 流量；</li>
</ul>
<p><img src="/images/kong.png" alt=""></p>
<p>Kong 的使用特别简单，需要搞懂几个概念就可以快速使用了：</p>
<ul>
<li>Service：Service 是要对外暴露的上游服务，类似于 Nginx 反向代理配置的 upstream；</li>
<li>Route：Route 定义了路由规则，外部流量如何路由到相应的 Service；</li>
<li>Consumer：类似账号的概念，可以设置不同的 Consumer 对 API 的访问限制；</li>
</ul>
<p>关于 Kong 数据持久化<br>Kong 有两种运行模式，以 <a href="https://docs.konghq.com/1.2.x/db-less-and-declarative-config/" target="_blank" rel="noopener">db-less</a> 模式运行时所有路由、Service 等信息都存储在内存中，这些信息都是通过 declarative 配置文件动态生成，然后加在到内存。另一种是以 db 模式运行，需要额外的数据库支持，用于存储路由、Service 等信息，这种方式是生产环境推荐的方式。Kong 支持两种数据库持久化：Postgres 或者 Cassandra。</p>
<h3 id="Konga-简介"><a href="#Konga-简介" class="headerlink" title="Konga 简介"></a>Konga 简介</h3><p><a href="https://github.com/pantsel/konga" target="_blank" rel="noopener">Konga</a> 是一个第三方开源的针对 Kong 网关的 UI 管理界面，与 Kong 没有关系。通过 Konga 我们可以可视化配置 Kong 相关的配置，在没有可视化界面的情况下只能通过 curl 调用 Kong 提供的 Admin API 来管理 Kong 配置，相对于可视化配置来说复杂度是显而易见的。Konga 支持的主要特性如下：</p>
<ul>
<li>管理所有 Kong Admin API 对象；</li>
<li>多个 Kong 节点管理；</li>
<li>使用快照备份、恢复 Kong 节点；</li>
<li>通过健康检查健康节点和 API 状态；</li>
<li>支持邮寄和 Slack 告警通知；</li>
<li>多用户管理；</li>
<li>支持数据库集成（MySQL，postgresSQL，MongoDB，SQL Server）；</li>
</ul>
<p>Konga 默认将用户信息和配置信息存在在本地磁盘文件，我们可以选择和数据库集成，将相关信息存储到数据库，这也是生产环境推荐的做法。</p>
<h3 id="使用-docker-compose-容器化构建-Kong-微服务网关平台"><a href="#使用-docker-compose-容器化构建-Kong-微服务网关平台" class="headerlink" title="使用 docker-compose 容器化构建 Kong 微服务网关平台"></a>使用 docker-compose 容器化构建 Kong 微服务网关平台</h3><p>使用 docker-compose 将 Kong 网关、Konga UI 管理页面、数据库三个服务组合起来，组成一个完整、可用的网关系统，Kong 网关和 Konga 服务共用一个 postgres 数据库。下面为启动整个系统完整的 docker-compose 文件，来自：<a href="https://gist.github.com/pantsel/73d949774bd8e917bfd3d9745d71febf" target="_blank" rel="noopener">https://gist.github.com/pantsel/73d949774bd8e917bfd3d9745d71febf</a> 在其基础上对存在的问题进行了修复：<br>docker-compose.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr"> kong-net:</span></span><br><span class="line"><span class="attr">  driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line">  <span class="comment"># Postgres: The database used by Kong</span></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line"><span class="attr">  kong-database:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">postgres:9.6</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-net</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      POSTGRES_USER:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">      POSTGRES_DB:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"5432:5432"</span></span><br><span class="line"><span class="attr">    healthcheck:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="string">["CMD",</span> <span class="string">"pg_isready"</span><span class="string">,</span> <span class="string">"-U"</span><span class="string">,</span> <span class="string">"kong"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">      retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line">  <span class="comment"># Kong database migration</span></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line"><span class="attr">  kong-migration:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">kong:latest</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">"kong migrations bootstrap"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-net</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">on-failure</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      KONG_PG_HOST:</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">    links:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-database</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line">  <span class="comment"># Kong: The API Gateway</span></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line"><span class="attr">  kong:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">kong:latest</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-net</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      KONG_PG_HOST:</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">      KONG_PROXY_LISTEN:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8000</span></span><br><span class="line"><span class="attr">      KONG_PROXY_LISTEN_SSL:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8443</span></span><br><span class="line"><span class="attr">      KONG_ADMIN_LISTEN:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8001</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-migration</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">    healthcheck:</span></span><br><span class="line"><span class="attr">      test:</span> <span class="string">["CMD",</span> <span class="string">"curl"</span><span class="string">,</span> <span class="string">"-f"</span><span class="string">,</span> <span class="string">"http://kong:8001"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      interval:</span> <span class="number">5</span><span class="string">s</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">2</span><span class="string">s</span></span><br><span class="line"><span class="attr">      retries:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8001:8001"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8000:8000"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8443:8443"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line">  <span class="comment"># Konga database prepare</span></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line"><span class="attr">  konga-prepare:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pantsel/konga:next</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">"-c prepare -a postgres -u postgresql://kong@kong-database:5432/konga_db"</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-net</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">on-failure</span></span><br><span class="line"><span class="attr">    links:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-database</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line">  <span class="comment"># Konga: Kong GUI</span></span><br><span class="line">  <span class="comment">#######################################</span></span><br><span class="line"><span class="attr">  konga:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">pantsel/konga:latest</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">kong-net</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      DB_ADAPTER:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">      DB_HOST:</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">      DB_USER:</span> <span class="string">kong</span></span><br><span class="line"><span class="attr">      TOKEN_SECRET:</span> <span class="string">km1GUr4RkcQD7DewhJPNXrCuZwcKmqjb</span></span><br><span class="line"><span class="attr">      DB_DATABASE:</span> <span class="string">konga_db</span></span><br><span class="line"><span class="attr">      NODE_ENV:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kong-database</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"1337:1337"</span></span><br></pre></td></tr></table></figure></p>
<p>docker-compose 一键启动相关服务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></p>
<p>启动后访问 <a href="http://nodeIP:1337" target="_blank" rel="noopener">http://nodeIP:1337</a> 即可看到 Konga 登陆注册页面，首次访问需要注册用户，随便填写用户名称、邮箱等相关信息即可：</p>
<p><img src="/images/konga1.png" alt=""></p>
<p>在登陆后页面比较简单，因为还没有连接到 Kong，下面配置连接到要管理的 Kong 节点：<br>Name：随便填写；<br>Kong Admin URL：填写 Kong Admin API 地址；</p>
<p><img src="/images/konga2.png" alt=""><br>连接到 Kong 节点后即可看到节点更详细的信息：</p>
<p><img src="/images/konga3.png" alt=""></p>
<h3 id="使用-Konga-可视化创建一个-Service-及路由"><a href="#使用-Konga-可视化创建一个-Service-及路由" class="headerlink" title="使用 Konga 可视化创建一个 Service 及路由"></a>使用 Konga 可视化创建一个 Service 及路由</h3><p>Kong 官方文档给了一个 Kong 的使用 <a href="https://docs.konghq.com/1.2.x/getting-started/configuring-a-service/" target="_blank" rel="noopener">例子</a>：通过 curl 调用 Kong Admin API 创建一个 Service 和路由，然后通过 curl 测试访问。这里我们演示如何通过 Konga 可视化做同样的配置：</p>
<p>首先创建一个 Service，指向 <a href="http://mockbin.org" target="_blank" rel="noopener">http://mockbin.org</a> 服务：</p>
<p><img src="/images/konga4.png" alt=""><br><img src="/images/konga5.png" alt=""></p>
<p>创建一个对外访问的路由，路由到上一步创建的 Service：</p>
<p><img src="/images/konga6.png" alt=""><br><img src="/images/konga7.png" alt=""><br><img src="/images/konga8.png" alt=""></p>
<p>上面配置中 Hosts 即为对外访问的 host 名称，只要将 api.example.com 绑定到网关 IP 地址即可进行访问，会路由到绑定的 Service：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://api.example.com:8000</span><br></pre></td></tr></table></figure></p>
<h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><p><a href="https://docs.konghq.com/" target="_blank" rel="noopener">https://docs.konghq.com/</a> | Kong 官方文档<br><a href="https://github.com/pantsel/konga/" target="_blank" rel="noopener">https://github.com/pantsel/konga/</a> | Konga GitHub 仓库<br><a href="https://gist.github.com/pantsel/73d949774bd8e917bfd3d9745d71febf" target="_blank" rel="noopener">https://gist.github.com/pantsel/73d949774bd8e917bfd3d9745d71febf</a> | kong docker-compose</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">haohao</p>
              <p class="site-description motion-element" itemprop="description">Talk is cheap. Show me the code.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">127</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/qhh0205" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://blog.csdn.net/qianghaohao" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://my.oschina.net/bufferoverflow" target="_blank" title="开源中国">
                      
                        <i class="fa fa-fw fa-globe"></i>开源中国</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:qhh0205@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">haohao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="/js/src/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
